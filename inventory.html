<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>생산/재고 관리 시스템</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 기본 폰트 및 커스텀 스타일 */
        body { font-family: 'Inter', 'Malgun Gothic', sans-serif; }
        .form-input { @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50; }
        .btn { @apply inline-flex items-center justify-center px-4 py-2 rounded-md font-semibold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform transform hover:scale-105; }
        .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 focus:ring-red-500; }
        .btn-subtle { @apply bg-indigo-100 text-indigo-700 hover:bg-indigo-200 focus:ring-indigo-500; }
        
        /* 페이지 전환용 클래스 */
        .app-page { display: none; }
        .active-app-page { display: block; }
        .main-content { display: none; }
        .active-main-content { display: block; }

        /* 모달 및 로더 스타일 */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 활성 탭/네비게이션 스타일 */
        .active-nav {
            color: #4f46e5; /* indigo-600 */
            font-weight: 700;
        }
        .active-tab {
            border-bottom-width: 3px;
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
        
        /* 테이블 스타일 */
        tbody tr:nth-child(odd) { background-color: #f9fafb; }
        tbody tr:hover { background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 로딩 스피너 -->
    <div id="loader-backdrop" class="modal-backdrop" style="display: none;">
        <div id="loader"></div>
    </div>

    <!-- 전체 컨테이너 -->
    <div id="app-container">

        <!-- ===== 사용자명 입력 페이지 ===== -->
        <div id="login-page" class="app-page active-app-page">
            <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-lg">
                    <div>
                        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900" data-lang-key="login_title">LOGIN</h2>
                    </div>
                    <div id="user-buttons-container" class="space-y-2">
                        <!-- 저장된 사용자 버튼이 여기에 표시됩니다. -->
                    </div>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div class="rounded-md shadow-sm">
                            <input id="username" name="username" type="text" required class="form-input text-center text-lg" placeholder="새로운 사용자명 입력" data-lang-key-placeholder="username_placeholder_new">
                        </div>
                        <p id="login-error" class="text-red-500 text-sm text-center"></p>
                        <div>
                            <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-lg font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-lang-key="register_btn">
                                등록
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ===== 메인 애플리케이션 ===== -->
        <div id="main-app" class="app-page">
            <!-- 헤더 및 네비게이션 -->
            <header class="bg-white shadow-md sticky top-0 z-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex-shrink-0">
                            <h1 class="text-2xl font-bold text-indigo-600" data-lang-key="app_title">생산/재고 관리</h1>
                        </div>
                        <nav class="hidden md:flex items-center space-x-8">
                            <a href="#" class="nav-link text-gray-500 hover:text-indigo-600 font-medium" data-page="list-page" data-lang-key="nav_home">HOME</a>
                            <a href="#" class="nav-link text-gray-500 hover:text-indigo-600 font-medium" data-page="production-page" data-lang-key="nav_production">생산 관리</a>
                            <a href="#" class="nav-link text-gray-500 hover:text-indigo-600 font-medium" data-page="inventory-page" data-lang-key="nav_inventory">입/출고 관리</a>
                            <a href="#" class="nav-link text-gray-500 hover:text-indigo-600 font-medium" data-page="employee-page" data-lang-key="nav_employee_management">직원 관리</a>
                        </nav>
                        <div class="flex items-center">
                            <span id="display-username" class="text-gray-800 font-semibold mr-4"></span>
                             <div class="mr-4">
                                <select id="language-switcher" class="form-input py-1 text-sm">
                                    <option value="ko">한국어</option>
                                    <option value="si">සිංහල</option>
                                </select>
                            </div>
                            <button id="logout-btn" class="btn btn-secondary text-sm">
                                <i class="fas fa-sign-out-alt mr-2"></i><span data-lang-key="logout_btn">로그아웃</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="p-4 md:p-8">
                <!-- 생산 관리 페이지 -->
                <div id="production-page" class="main-content">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <input type="hidden" id="editing-doc-id">
                        <h2 class="text-2xl font-bold mb-6" data-lang-key="production_title">생산 기록</h2>
                        
                        <!-- 공통 정보 섹션 -->
                        <div class="mb-8 p-4 border rounded-lg bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                                <div>
                                    <label class="font-semibold" data-lang-key="form_date">날짜</label>
                                    <input type="date" id="prod-common-date" class="form-input mt-1" required>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="font-semibold" data-lang-key="form_attendance">직원 근태</label>
                                        <button id="go-to-employee-page-btn" class="text-sm text-indigo-600 hover:underline"><i class="fas fa-user-plus mr-1"></i><span data-lang-key="add_employee_link">직원 등록 바로가기</span></button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <div class="attendance-display-area border-2 border-dashed rounded-md p-2 min-h-[40px] flex flex-wrap gap-2 items-center cursor-pointer hover:border-indigo-400 bg-white" data-shift="day">
                                                <span class="text-gray-400 text-sm attendance-placeholder" data-lang-key="shift_day">주간</span>
                                            </div>
                                            <input type="hidden" id="prod-common-attendance-day">
                                        </div>
                                        <div>
                                            <div class="attendance-display-area border-2 border-dashed rounded-md p-2 min-h-[40px] flex flex-wrap gap-2 items-center cursor-pointer hover:border-indigo-400 bg-white" data-shift="night">
                                                <span class="text-gray-400 text-sm attendance-placeholder" data-lang-key="shift_night">야간</span>
                                            </div>
                                            <input type="hidden" id="prod-common-attendance-night">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 기계별 생산 정보 섹션 -->
                        <div id="production-forms-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- 기계 1, 2, 3호기 템플릿이 여기에 동적으로 추가됩니다 -->
                        </div>

                        <!-- 저장 버튼 섹션 -->
                        <div class="flex justify-end gap-4 mt-8 border-t pt-6">
                            <button type="button" id="clear-all-prod-forms-btn" class="btn btn-secondary"><i class="fas fa-undo mr-2"></i><span data-lang-key="btn_clear_all">전체 초기화</span></button>
                            <button type="button" id="save-all-prod-forms-btn" class="btn btn-primary"><i class="fas fa-save mr-2"></i><span data-lang-key="btn_save_all">일괄 저장</span></button>
                        </div>
                    </div>
                </div>

                <!-- 입/출고 관리 페이지 -->
                <div id="inventory-page" class="main-content">
                     <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="mb-4 border-b border-gray-200">
                            <nav class="flex space-x-6" aria-label="Tabs">
                                <button class="inventory-tab-btn active-tab pb-2 font-medium" data-target="inbound-section" data-lang-key="inventory_in_title">입고 관리</button>
                                <button class="inventory-tab-btn pb-2 font-medium text-gray-500 hover:text-gray-700" data-target="outbound-section" data-lang-key="inventory_out_title">출고 관리</button>
                            </nav>
                        </div>
                        
                        <!-- 입고 관리 섹션 -->
                        <div id="inbound-section" class="inventory-section">
                            <h3 class="text-xl font-semibold mb-4" data-lang-key="inventory_in_external">외부 입고 등록</h3>
                            <form id="inbound-form" class="space-y-3 max-w-lg mx-auto">
                                <div class="grid grid-cols-3 items-center">
                                    <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_inbound_date">입고일</label>
                                    <div class="col-span-2"><input type="date" id="inbound-date" class="form-input" required></div>
                                </div>
                                <div class="grid grid-cols-3 items-center">
                                    <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_client">업체명</label>
                                    <div class="col-span-2"><input type="text" id="inbound-client" class="form-input text-right" required></div>
                                </div>
                                <div class="grid grid-cols-3 items-center">
                                    <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_item_name">품명</label>
                                    <div class="col-span-2"><input type="text" id="inbound-item" class="form-input text-right" required></div>
                                </div>
                                <div class="grid grid-cols-3 items-center">
                                    <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_inbound_qty">입고량(kg)</label>
                                    <div class="col-span-2"><input type="number" id="inbound-qty" class="form-input text-right" required></div>
                                </div>
                                <div class="text-right pt-2">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle mr-2"></i><span data-lang-key="btn_inbound_add">입고 등록</span></button>
                                </div>
                            </form>
                        </div>

                        <!-- 출고 관리 섹션 -->
                        <div id="outbound-section" class="inventory-section" style="display: none;">
                            <!-- 생산품 출고 -->
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold mb-4" data-lang-key="inventory_out_prod">생산품 출고</h3>
                                <form id="outbound-prod-form" class="space-y-4 max-w-2xl mx-auto">
                                    <div class="grid grid-cols-3 items-center">
                                        <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_outbound_date">출고일</label>
                                        <div class="col-span-2"><input type="date" id="outbound-prod-date" class="form-input" required></div>
                                    </div>
                                    <div id="outbound-items-container" class="space-y-4">
                                        <!-- 출고 항목이 동적으로 추가됩니다 -->
                                    </div>
                                    <button type="button" id="add-outbound-item-btn" class="btn btn-subtle w-full"><i class="fas fa-plus mr-2"></i><span data-lang-key="btn_add_outbound_item">출고 항목 추가</span></button>
                                    <div class="text-right pt-2">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-truck-loading mr-2"></i><span data-lang-key="btn_outbound_process">일괄 출고 처리</span></button>
                                    </div>
                                </form>
                            </div>

                            <!-- 입고품 출고 -->
                            <div class="border-t pt-6">
                                <h3 class="text-xl font-semibold mb-4" data-lang-key="inventory_out_inbound">입고품 출고</h3>
                                <form id="outbound-inbound-form" class="space-y-3 max-w-lg mx-auto">
                                    <div class="grid grid-cols-3 items-center">
                                        <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_select_inbound_item">입고 품목 선택</label>
                                        <div class="col-span-2"><select id="outbound-inbound-item-select" class="form-input" required></select></div>
                                    </div>
                                    <div class="grid grid-cols-3 items-center">
                                        <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_outbound_date">출고일</label>
                                        <div class="col-span-2"><input type="date" id="outbound-inbound-date" class="form-input" required></div>
                                    </div>
                                    <div class="grid grid-cols-3 items-center">
                                        <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_outbound_qty">출고량(kg)</label>
                                        <div class="col-span-2"><input type="number" id="outbound-inbound-qty" class="form-input text-right" required></div>
                                    </div>
                                    <div class="grid grid-cols-3 items-center">
                                        <label class="font-semibold col-span-1 text-right pr-4" data-lang-key="form_outbound_purpose">출고 목적</label>
                                        <div class="col-span-2">
                                            <select id="outbound-inbound-purpose" class="form-input" required>
                                                <option value="생산" data-lang-key="purpose_production">생산</option>
                                                <option value="배합" data-lang-key="purpose_mixing">배합</option>
                                                <option value="반품" data-lang-key="purpose_return">반품</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="text-right pt-2">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-truck-loading mr-2"></i><span data-lang-key="btn_outbound_process_single">출고 처리</span></button>
                                    </div>
                                </form>
                            </div>
                        </div>
                     </div>
                </div>
                
                <!-- 직원 관리 페이지 -->
                <div id="employee-page" class="main-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-1">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h2 class="text-2xl font-bold mb-4" data-lang-key="add_employee_title">직원 등록</h2>
                                <form id="add-employee-form" class="space-y-4">
                                    <div>
                                        <label for="employee-name" class="font-semibold" data-lang-key="employee_name_label">직원 이름</label>
                                        <input type="text" id="employee-name" class="form-input mt-1" data-lang-key-placeholder="employee_name_placeholder" placeholder="이름을 입력하세요" required>
                                    </div>
                                    <div class="text-right">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i><span data-lang-key="add_employee_btn">등록</span></button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h2 class="text-2xl font-bold mb-4" data-lang-key="employee_list_title">직원 목록</h2>
                                <div id="employee-list" class="space-y-2">
                                    <!-- 직원 목록이 여기에 표시됩니다. -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 통합 목록 페이지 (HOME) -->
                <div id="list-page" class="main-content">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4" data-lang-key="home_title">HOME</h2>
                        <!-- 필터 -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-md bg-gray-50">
                            <input type="date" id="filter-date" class="form-input" placeholder="날짜 필터">
                            <input type="text" id="filter-client" class="form-input" data-lang-key-placeholder="filter_client" placeholder="업체명 필터">
                            <input type="text" id="filter-lot" class="form-input" data-lang-key-placeholder="filter_lot" placeholder="LOT 필터">
                            <button id="filter-reset-btn" class="btn btn-secondary"><i class="fas fa-sync-alt mr-2"></i><span data-lang-key="btn_filter_reset">필터 초기화</span></button>
                        </div>
                        
                        <!-- 데이터 탭 -->
                        <div class="mb-4 border-b border-gray-200">
                            <nav class="flex space-x-6" aria-label="Tabs">
                                <button class="list-tab-btn active-tab pb-2 font-medium" data-target="production-list-container" data-lang-key="tab_production">생산 목록</button>
                                <button class="list-tab-btn pb-2 font-medium text-gray-500 hover:text-gray-700" data-target="inbound-list-container" data-lang-key="tab_inbound">입고 목록</button>
                                <button class="list-tab-btn pb-2 font-medium text-gray-500 hover:text-gray-700" data-target="prod-outbound-list-container" data-lang-key="tab_prod_outbound">생산품 출고</button>
                                <button class="list-tab-btn pb-2 font-medium text-gray-500 hover:text-gray-700" data-target="inbound-outbound-list-container" data-lang-key="tab_inbound_outbound">입고품 출고</button>
                            </nav>
                        </div>

                        <!-- 생산 목록 -->
                        <div id="production-list-container" class="list-container">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold" data-lang-key="list_production_title">생산 데이터</h3>
                                <div class="font-bold text-lg bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg">
                                    <span data-lang-key="total_production">금월 총 생산량:</span>
                                    <span id="monthly-total-production">0</span> kg
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white text-sm">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_date">날짜</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_client">업체명</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_grade">GRADE</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_label_lot">라벨LOT</th>
                                            <th class="py-2 px-3 text-right" data-lang-key="th_prod_qty">생산량</th>
                                            <th class="py-2 px-3 text-right" data-lang-key="th_stock_qty">현재고</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_author">작성자</th>
                                            <th class="py-2 px-3 text-center" data-lang-key="th_actions">작업</th>
                                        </tr>
                                    </thead>
                                    <tbody id="production-list-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 입고 목록 -->
                        <div id="inbound-list-container" class="list-container" style="display: none;">
                             <h3 class="text-xl font-semibold mb-4" data-lang-key="list_inbound_title">입고 데이터</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white text-sm">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_inbound_date">입고일</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_client">업체명</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_item_name">품명</th>
                                            <th class="py-2 px-3 text-right" data-lang-key="th_inbound_qty">입고량</th>
                                            <th class="py-2 px-3 text-right" data-lang-key="th_stock_qty">현재고</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_author">작성자</th>
                                            <th class="py-2 px-3 text-center" data-lang-key="th_actions">작업</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inbound-list-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 생산품 출고 목록 -->
                        <div id="prod-outbound-list-container" class="list-container" style="display: none;">
                             <h3 class="text-xl font-semibold mb-4" data-lang-key="list_prod_outbound_title">생산품 출고 내역</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white text-sm">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_outbound_date">출고일</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_item_name">품명</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_client">업체명</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_label_lot">라벨LOT</th>
                                            <th class="py-2 px-3 text-right" data-lang-key="th_outbound_qty">출고량</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_author">처리자</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prod-outbound-list-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 입고품 출고 목록 -->
                        <div id="inbound-outbound-list-container" class="list-container" style="display: none;">
                             <h3 class="text-xl font-semibold mb-4" data-lang-key="list_inbound_outbound_title">입고품 출고 내역</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white text-sm">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_outbound_date">출고일</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_item_name">품명</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_client">업체명</th>
                                            <th class="py-2 px-3 text-right" data-lang-key="th_outbound_qty">출고량</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_outbound_purpose">출고 목적</th>
                                            <th class="py-2 px-3 text-left" data-lang-key="th_author">처리자</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inbound-outbound-list-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="delete-confirm-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold mb-4" data-lang-key="delete_confirm_title">삭제 확인</h3>
            <p class="mb-6" data-lang-key="delete_confirm_msg">정말로 이 항목을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="btn btn-secondary"><i class="fas fa-times mr-2"></i><span data-lang-key="btn_cancel">취소</span></button>
                <button id="confirm-delete-btn" class="btn btn-danger"><i class="fas fa-trash-alt mr-2"></i><span data-lang-key="btn_delete">삭제</span></button>
            </div>
        </div>
    </div>
    
    <!-- 직원 선택 모달 -->
    <div id="employee-select-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" data-lang-key="employee_select_title">근무 직원 선택</h3>
            <div id="employee-select-list" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-6">
                <!-- 직원 선택 목록이 여기에 표시됩니다. -->
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancel-employee-select-btn" class="btn btn-secondary" data-lang-key="btn_cancel">취소</button>
                <button id="save-employee-select-btn" class="btn btn-primary" data-lang-key="btn_confirm">확인</button>
            </div>
        </div>
    </div>
    
    <!-- 데이터 검색 모달 -->
    <div id="data-search-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" data-lang-key="data_search_title">데이터 검색 결과</h3>
            <div id="search-results-list" class="space-y-2 mb-6 max-h-64 overflow-y-auto">
                <!-- 검색 결과가 여기에 표시됩니다. -->
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancel-search-btn" class="btn btn-secondary" data-lang-key="btn_cancel">취소</button>
                <button id="apply-search-btn" class="btn btn-primary" data-lang-key="btn_apply">적용</button>
            </div>
        </div>
    </div>


    <!-- 알림 모달 -->
    <div id="alert-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content text-center">
            <h3 id="alert-title" class="text-xl font-bold mb-4"></h3>
            <p id="alert-message" class="mb-6"></p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="btn btn-primary">확인</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // # 파이어베이스 SDK 임포트
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot,
            doc,
            deleteDoc,
            updateDoc,
            query,
            getDoc,
            getDocs,
            writeBatch,
            where,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // # 파이어베이스 설정
        const firebaseConfig = {
            apiKey: "AIzaSyAj0gDx9SNSrPaQIFvcgJx1IEmqgEF6ZHM",
            authDomain: "color-match-a618d.firebaseapp.com",
            projectId: "color-match-a618d",
            storageBucket: "color-match-a618d.appspot.com",
            messagingSenderId: "231274435725",
            appId: "1:231274435725:web:1f51c9d149ef0ecacabec4"
        };

        // # 파이어베이스 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // # 다국어 텍스트 객체
        const translations = {
            ko: {
                login_title: "LOGIN", username_placeholder: "사용자명을 입력하세요", username_placeholder_new: "새로운 사용자명 입력", register_btn: "등록",
                app_title: "생산/재고 관리", nav_production: "생산 관리", nav_inventory: "입/출고 관리", nav_home: "HOME", logout_btn: "로그아웃", nav_employee_management: "직원 관리",
                production_title: "생산 기록", form_date: "날짜", form_client: "업체명", form_item_name: "품명", form_grade: "GRADE", form_mix_lot: "배합LOT", form_machine: "기계", form_shift: "교대", form_mesh: "망(Mesh)", form_temp: "온도조건(℃)", form_label_lot: "라벨LOT", form_bag_no: "BAG NO", form_prod_qty: "생산량(kg)", form_notes: "비고", form_attendance: "직원 근태", form_test_sample: "TEST/SAMPLE", form_loss: "Loss율/내용", btn_clear_all: "전체 초기화", btn_save_all: "일괄 저장", daily_notes_section_title: "특이사항", form_packaging_condition: "포장조건(kg)", btn_add_job: "작업 추가", btn_copy_shift: "주간 내용 복사",
                inventory_in_title: "입고 관리", inventory_in_external: "외부 입고 등록", form_inbound_date: "입고일", form_inbound_qty: "입고량(kg)", btn_inbound_add: "입고 등록",
                inventory_out_title: "출고 관리", inventory_out_prod: "생산품 출고", form_select_prod_lot: "생산 LOT 선택", form_outbound_date: "출고일", form_outbound_qty: "출고량(kg)", btn_outbound_process: "일괄 출고 처리", btn_outbound_process_single: "출고 처리", btn_add_outbound_item: "출고 항목 추가",
                inventory_out_inbound: "입고품 출고", form_select_inbound_item: "입고 품목 선택", form_outbound_purpose: "출고 목적", purpose_production: "생산", purpose_mixing: "배합", purpose_return: "반품",
                home_title: "HOME", filter_client: "업체명 필터", filter_lot: "LOT 필터", btn_filter_reset: "필터 초기화",
                tab_production: "생산 목록", tab_inbound: "입고 목록", tab_prod_outbound: "생산품 출고", tab_inbound_outbound: "입고품 출고",
                list_production_title: "생산 데이터", total_production: "금월 총 생산량:",
                th_date: "날짜", th_client: "업체명", th_grade: "GRADE", th_label_lot: "라벨LOT", th_prod_qty: "생산량", th_stock_qty: "현재고", th_author: "작성자", th_actions: "작업",
                list_inbound_title: "입고 데이터", th_inbound_date: "입고일", th_item_name: "품명", th_inbound_qty: "입고량",
                list_prod_outbound_title: "생산품 출고 내역", list_inbound_outbound_title: "입고품 출고 내역", th_outbound_date: "출고일", th_outbound_qty: "출고량", th_outbound_purpose: "출고 목적",
                delete_confirm_title: "삭제 확인", delete_confirm_msg: "정말로 이 항목을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.", btn_cancel: "취소", btn_delete: "삭제", btn_confirm: "확인", btn_apply: "적용",
                alert_success: "성공", alert_error: "오류", alert_saved: "성공적으로 저장되었습니다.", alert_updated: "성공적으로 수정되었습니다.", alert_deleted: "삭제되었습니다.", alert_outbound_processed: "출고 처리되었습니다.", alert_inbound_added: "입고 등록되었습니다.", alert_stock_insufficient: "재고가 부족합니다.", alert_fill_all_fields: "모든 필수 항목을 입력해주세요.", alert_invalid_qty: "유효한 수량을 입력해주세요.", alert_enter_username: "사용자명을 입력해주세요.",
                machine_no: "호기", shift_day: "주간", shift_night: "야간",
                alert_no_prod_data: "저장할 생산 데이터가 없습니다. 생산량을 입력해주세요.", alert_common_info_missing: "날짜를 먼저 입력해주세요.",
                add_employee_title: "직원 등록", employee_name_label: "직원 이름", employee_name_placeholder: "이름을 입력하세요", add_employee_btn: "등록", employee_list_title: "직원 목록", employee_select_title: "근무 직원 선택", attendance_placeholder: "직원을 선택하세요", add_employee_link: "직원 등록 바로가기",
                select_item: "품목 선택", select_client_grade: "업체+GRADE 선택", select_lot: "LOT 선택",
                data_search_title: "데이터 검색 결과", search_btn: "검색", no_search_results: "검색 결과가 없습니다.", select_data_to_apply: "적용할 데이터를 선택하세요.",
            },
            si: {
                username_login_title: "LOGIN", username_placeholder: "ඔබගේ නම ඇතුලත් කරන්න", username_placeholder_new: "නව පරිශීලක නාමය ඇතුළත් කරන්න", register_btn: "ලියාපදිංචි වන්න",
                app_title: "නිෂ්පාදන/තොග කළමනාකරණය", nav_production: "නිෂ්පාදන කළමනාකරණය", nav_inventory: "ඇතුල්වීම්/පිටවීම්", nav_home: "මුල් පිටුව", logout_btn: "පිටවීම", nav_employee_management: "සේවක කළමනාකරණය",
                production_title: "නිෂ්පාදන වාර්තාව", form_date: "දිනය", form_client: "සමාගමේ නම", form_item_name: "භාණ්ඩයේ නම", form_grade: "GRADE", form_mix_lot: "මිශ්‍ර LOT", form_machine: "යන්ත්‍රය", form_shift: "මාරුව", form_mesh: "දැල (Mesh)", form_temp: "උෂ්ණත්ව තත්ත්වය(℃)", form_label_lot: "ලේබල් LOT", form_bag_no: "BAG NO", form_prod_qty: "නිෂ්පාදන ප්‍රමාණය(kg)", form_notes: "සටහන්", form_attendance: "සේවක පැමිණීම", form_test_sample: "TEST/SAMPLE", form_loss: "පාඩු අනුපාතය/හේතුව", btn_clear_all: "සියල්ල හිස් කරන්න", btn_save_all: "සියල්ල සුරකින්න", daily_notes_section_title: "විශේෂ සටහන්", form_packaging_condition: "ඇසුරුම් තත්ත්වය(kg)", btn_add_job: "කාර්යය එක් කරන්න", btn_copy_shift: "දවල් මාරුවේ අන්තර්ගතය පිටපත් කරන්න",
                inventory_in_title: "ඇතුල්වීම් කළමනාකරණය", inventory_in_external: "බාහිර ඇතුල්වීම් ලියාපදිංචිය", form_inbound_date: "ඇතුල්වූ දිනය", form_inbound_qty: "ඇතුල්වූ ප්‍රමාණය(kg)", btn_inbound_add: "ඇතුල්වීම ලියාපදිංචි කරන්න",
                inventory_out_title: "පිටවීම් කළමනාකරණය", inventory_out_prod: "නිෂ්පාදිත භාණ්ඩ පිටවීම", form_select_prod_lot: "නිෂ්පාදන LOT තෝරන්න", form_outbound_date: "පිටවූ දිනය", form_outbound_qty: "පිටවූ ප්‍රමාණය(kg)", btn_outbound_process: "සියල්ල පිටවීම සකසන්න", btn_outbound_process_single: "පිටවීම සකසන්න", btn_add_outbound_item: "පිටවීමේ අයිතමය එක් කරන්න",
                inventory_out_inbound: "ඇතුල්වූ භාණ්ඩ පිටවීම", form_select_inbound_item: "ඇතුල්වූ භාණ්ඩය තෝරන්න", form_outbound_purpose: "පිටවීමේ අරමුණ", purpose_production: "නිෂ්පාදනය", purpose_mixing: "මිශ්‍ර කිරීම", purpose_return: "ආපසු යැවීම",
                home_title: "මුල් පිටුව", filter_client: "සමාගමේ නම අනුව පෙරහන් කරන්න", filter_lot: "LOT අනුව පෙරහන් කරන්න", btn_filter_reset: "පෙරහන යළි පිහිටුවන්න",
                tab_production: "නිෂ්පාදන ලැයිස්තුව", tab_inbound: "ඇතුල්වීම් ලැයිස්තුව", tab_prod_outbound: "නිෂ්පාදිත භාණ්ඩ පිටවීම්", tab_inbound_outbound: "ඇතුල්වූ භාණ්ඩ පිටවීම්",
                list_production_title: "නිෂ්පාදන දත්ත", total_production: "මෙම මස මුළු නිෂ්පාදනය:",
                th_date: "දිනය", th_client: "සමාගමේ නම", th_grade: "GRADE", th_label_lot: "ලේබල් LOT", th_prod_qty: "නිෂ්පාදන ප්‍රමාණය", th_stock_qty: "වත්මන් තොගය", th_machine: "යන්ත්‍රය", th_author: "ලියන්නා", th_actions: "ක්‍රියා",
                list_inbound_title: "ඇතුල්වීම් දත්ත", th_inbound_date: "ඇතුල්වූ දිනය", th_item_name: "භාණ්ඩයේ නම", th_inbound_qty: "ඇතුල්වූ ප්‍රමාණය",
                list_prod_outbound_title: "නිෂ්පාදිත භාණ්ඩ පිටවීමේ විස්තර", list_inbound_outbound_title: "ඇතුල්වූ භාණ්ඩ පිටවීමේ විස්තර", th_outbound_date: "පිටවූ දිනය", th_outbound_qty: "පිටවූ ප්‍රමාණය", th_outbound_purpose: "පිටවීමේ අරමුණ",
                delete_confirm_title: "මකාදැමීම තහවුරු කරන්න", delete_confirm_msg: "ඔබට මෙම අයිතමය මකා දැමීමට අවශ්‍ය බව විශ්වාසද? මෙම ක්‍රියාව ආපසු හැරවිය නොහැක.", btn_cancel: "අවලංගු කරන්න", btn_delete: "මකා දමන්න", btn_confirm: "තහවුරු කරන්න", btn_apply: "යොදවන්න",
                alert_success: "සාර්ථකයි", alert_error: "දෝෂයකි", alert_saved: "සාර්ථකව සුරකින ලදි.", alert_updated: "සාර්ථකව යාවත්කාලීන කරන ලදි.", alert_deleted: "මකා දමන ලදි.", alert_outbound_processed: "පිටවීම සකසන ලදි.", alert_inbound_added: "ඇතුල්වීම ලියාපදිංචි කරන ලදි.", alert_stock_insufficient: "තොග ප්‍රමාණවත් නොවේ.", alert_fill_all_fields: "කරුණාකර අවශ්‍ය සියලුම ක්ෂේත්‍ර පුරවන්න.", alert_invalid_qty: "කරුණාකර වලංගු ප්‍රමාණයක් ඇතුළත් කරන්න.", alert_enter_username: "කරුණාකර පරිශීලක නාමයක් ඇතුළත් කරන්න.",
                machine_no: " යන්ත්‍රය", shift_day: "දවල්", shift_night: "රාත්‍රී",
                alert_no_prod_data: "සුරැකීමට නිෂ්පාදන දත්ත නොමැත. කරුණාකර නිෂ්පාදන ප්‍රමාණය ඇතුළත් කරන්න.", alert_common_info_missing: "කරුණාකර පළමුව දිනය ඇතුළත් කරන්න.",
                add_employee_title: "සේවක ලියාපදිංචිය", employee_name_label: "සේවක නම", employee_name_placeholder: "නම ඇතුළත් කරන්න", add_employee_btn: "ලියාපදිංචි කරන්න", employee_list_title: "සේවක ලැයිස්තුව", employee_select_title: "සේවකයා තෝරන්න", attendance_placeholder: "සේවකයෙකු තෝරන්න", add_employee_link: "සේවක ලියාපදිංචියට යන්න",
                select_item: "භාණ්ඩය තෝරන්න", select_client_grade: "සමාගම+GRADE තෝරන්න", select_lot: "LOT තෝරන්න",
                data_search_title: "දත්ත සෙවුම් ප්‍රතිඵල", search_btn: "සොයන්න", no_search_results: "සෙවුම් ප්‍රතිඵල නොමැත.", select_data_to_apply: "යෙදීමට දත්ත තෝරන්න.",
            }
        };

        let currentLang = 'ko';
        let currentUsername = '';
        let currentEditingAttendanceShift = null;
        let allEmployees = [];
        let availableProductionStock = [];
        let currentCardForDataApply = null;

        const loader = document.getElementById('loader-backdrop');
        const showLoader = () => loader.style.display = 'flex';
        const hideLoader = () => loader.style.display = 'none';

        // # 다국어 적용 함수
        const setLanguage = (lang) => {
            currentLang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang] && translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-key-placeholder');
                 if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            createProductionForms();
        };
        
        // # 알림 모달 함수
        const showAlert = (title, message) => {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-modal').style.display = 'flex';
        };
        
        document.getElementById('alert-ok-btn').addEventListener('click', () => {
            document.getElementById('alert-modal').style.display = 'none';
        });

        // # 페이지 전환 함수
        const showAppPage = (pageId) => {
            document.querySelectorAll('.app-page').forEach(page => page.classList.remove('active-app-page'));
            document.getElementById(pageId).classList.add('active-app-page');
        };

        const showMainContentPage = (pageId) => {
            document.querySelectorAll('.main-content').forEach(page => page.classList.remove('active-main-content'));
            document.getElementById(pageId).classList.add('active-main-content');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active-nav');
                if(link.dataset.page === pageId) {
                    link.classList.add('active-nav');
                }
            });
        };

        // # 사용자명 입력 처리
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            if (username) {
                loginUser(username);
            } else {
                document.getElementById('login-error').textContent = translations[currentLang].alert_enter_username;
            }
        });

        // # 로그아웃 처리
        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUsername = '';
            document.getElementById('username').value = '';
            showAppPage('login-page');
        });
        
        // # 언어 변경 처리
        document.getElementById('language-switcher').addEventListener('change', (e) => setLanguage(e.target.value));

        // # 네비게이션 링크 클릭 처리
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showMainContentPage(e.target.dataset.page);
            });
        });

        // # 생산 관리 페이지 - 단일 작업 카드 HTML 생성 헬퍼
        const createJobCardHTML = (machineNum, shift, jobIndex) => {
            const t = translations[currentLang];
            const deleteButtonHTML = jobIndex > 1 ? `<button type="button" class="delete-job-card-btn absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times-circle fa-lg"></i></button>` : '';

            return `
                <div class="prod-form-card relative border p-4 rounded-lg shadow-sm bg-white" data-machine="${machineNum}" data-shift="${shift}" data-job-index="${jobIndex}">
                    ${deleteButtonHTML}
                    <div class="grid grid-cols-3 items-center gap-y-3 gap-x-2">
                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_client}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-client text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_item_name}</label>
                        <div class="col-span-2 relative flex items-center">
                            <input type="text" class="form-input prod-item-name text-right pr-10">
                            <button type="button" class="search-data-btn absolute right-0 top-0 h-full px-3 text-gray-500 hover:text-indigo-600"><i class="fas fa-search"></i></button>
                        </div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_grade}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-grade text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_mesh}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-mesh text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_packaging_condition}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-packaging-condition text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_temp}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-temp text-right"></div>
                        
                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_mix_lot}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-mix-lot text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_label_lot}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-label-lot text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_bag_no}</label>
                        <div class="col-span-2"><input type="text" class="form-input prod-bag-no text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_prod_qty}</label>
                        <div class="col-span-2"><input type="number" class="form-input prod-qty text-right"></div>

                        <label class="col-span-1 font-semibold text-sm text-right pr-2 self-start pt-2">${t.form_notes}</label>
                        <div class="col-span-2"><textarea class="form-input prod-notes text-right"></textarea></div>

                        <div class="col-span-3 border-t pt-3 mt-1">
                            <label class="font-semibold text-sm">${t.daily_notes_section_title}</label>
                            <div class="grid grid-cols-2 gap-4 mt-1">
                                    <input type="text" class="form-input prod-test-sample text-right" data-lang-key-placeholder="form_test_sample" placeholder="TEST/SAMPLE">
                                    <input type="text" class="form-input prod-loss text-right" data-lang-key-placeholder="form_loss" placeholder="Loss율/내용">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // # 생산 관리 페이지 - 기계/교대별 폼 생성
        const createProductionForms = () => {
            const container = document.getElementById('production-forms-container');
            container.innerHTML = '';
            const t = translations[currentLang];

            for (let i = 1; i <= 3; i++) {
                const machineDiv = document.createElement('div');
                machineDiv.className = 'space-y-4';
                machineDiv.innerHTML = `<h3 class="text-xl font-bold text-center text-gray-700">${i}${t.machine_no}</h3>`;

                // Day Shift Container
                machineDiv.innerHTML += `
                    <div class="shift-container border-t-4 border-yellow-400 pt-2">
                        <h4 class="text-lg font-semibold mb-2 text-yellow-600">${t.shift_day}</h4>
                        <div id="machine-${i}-day-jobs" class="space-y-4">${createJobCardHTML(i, 'day', 1)}</div>
                        <button class="btn btn-subtle btn-sm w-full mt-2 add-job-btn" data-machine="${i}" data-shift="day"><i class="fas fa-plus mr-2"></i>${t.btn_add_job}</button>
                    </div>
                `;

                // Copy Button
                machineDiv.innerHTML += `
                    <div class="text-center">
                        <button class="btn btn-secondary btn-sm copy-shift-btn" data-machine="${i}"><i class="fas fa-copy mr-2"></i>${t.btn_copy_shift}</button>
                    </div>
                `;

                // Night Shift Container
                machineDiv.innerHTML += `
                     <div class="shift-container border-t-4 border-blue-800 pt-2">
                        <h4 class="text-lg font-semibold mb-2 text-blue-800">${t.shift_night}</h4>
                        <div id="machine-${i}-night-jobs" class="space-y-4">${createJobCardHTML(i, 'night', 1)}</div>
                        <button class="btn btn-subtle btn-sm w-full mt-2 add-job-btn" data-machine="${i}" data-shift="night"><i class="fas fa-plus mr-2"></i>${t.btn_add_job}</button>
                    </div>
                `;

                container.appendChild(machineDiv);
            }
        };

        // # 생산 페이지 이벤트 위임 (작업 추가, 내용 복사, 작업 삭제, 검색)
        document.getElementById('production-forms-container').addEventListener('click', (e) => {
            const addBtn = e.target.closest('.add-job-btn');
            const copyBtn = e.target.closest('.copy-shift-btn');
            const deleteBtn = e.target.closest('.delete-job-card-btn');
            const searchBtn = e.target.closest('.search-data-btn');

            if (addBtn) {
                const { machine, shift } = addBtn.dataset;
                const jobsContainer = document.getElementById(`machine-${machine}-${shift}-jobs`);
                const newJobIndex = jobsContainer.children.length + 1;
                jobsContainer.insertAdjacentHTML('beforeend', createJobCardHTML(machine, shift, newJobIndex));
            }

            if (copyBtn) {
                const { machine } = copyBtn.dataset;
                const dayCards = document.querySelectorAll(`#machine-${machine}-day-jobs .prod-form-card`);
                const nightCards = document.querySelectorAll(`#machine-${machine}-night-jobs .prod-form-card`);
                if (dayCards.length > 0 && nightCards.length > 0) {
                    const lastDayCard = dayCards[dayCards.length - 1];
                    const lastNightCard = nightCards[nightCards.length - 1];
                    const inputsToCopy = ['prod-client', 'prod-item-name', 'prod-grade', 'prod-mix-lot', 'prod-mesh', 'prod-packaging-condition', 'prod-temp', 'prod-label-lot', 'prod-bag-no', 'prod-qty', 'prod-notes', 'prod-test-sample', 'prod-loss'];
                    inputsToCopy.forEach(className => {
                        const sourceInput = lastDayCard.querySelector(`.${className}`);
                        const targetInput = lastNightCard.querySelector(`.${className}`);
                        if (sourceInput && targetInput) {
                            targetInput.value = sourceInput.value;
                        }
                    });
                }
            }
            
            if (deleteBtn) {
                deleteBtn.closest('.prod-form-card').remove();
            }

            if(searchBtn) {
                const card = searchBtn.closest('.prod-form-card');
                openDataSearchModal(card);
            }
        });

        // # 모든 생산 폼 초기화
        document.getElementById('clear-all-prod-forms-btn').addEventListener('click', () => {
            document.getElementById('prod-common-date').value = '';
            document.getElementById('editing-doc-id').value = '';
            document.querySelectorAll('.attendance-display-area').forEach(area => {
                const shift = area.dataset.shift;
                area.innerHTML = `<span class="text-gray-400 text-sm attendance-placeholder" data-lang-key="shift_${shift}">${translations[currentLang]['shift_' + shift]}</span>`;
            });
            createProductionForms(); // 폼 구조를 초기 상태로 리셋
        });

        // # 생산 데이터 일괄 저장 또는 업데이트
        document.getElementById('save-all-prod-forms-btn').addEventListener('click', async () => {
            const commonDate = document.getElementById('prod-common-date').value;
            const dayAttendanceData = document.getElementById('prod-common-attendance-day').value;
            const nightAttendanceData = document.getElementById('prod-common-attendance-night').value;

            if (!commonDate) {
                showAlert(translations[currentLang].alert_error, translations[currentLang].alert_common_info_missing);
                return;
            }

            showLoader();
            
            // # 1. 모든 작업 카드의 데이터를 수집
            const allJobs = [];
            document.querySelectorAll('.prod-form-card').forEach(card => {
                const prodQty = Number(card.querySelector('.prod-qty').value);
                if (prodQty > 0) {
                    const shift = card.dataset.shift;
                    const attendanceData = shift === 'day' ? dayAttendanceData : nightAttendanceData;
                    allJobs.push({
                        client: card.querySelector('.prod-client').value,
                        itemName: card.querySelector('.prod-item-name').value,
                        machine: card.dataset.machine,
                        shift: shift === 'day' ? '주간' : '야간',
                        grade: card.querySelector('.prod-grade').value,
                        mixLot: card.querySelector('.prod-mix-lot').value,
                        mesh: card.querySelector('.prod-mesh').value,
                        packagingCondition: card.querySelector('.prod-packaging-condition').value,
                        temperature: card.querySelector('.prod-temp').value,
                        labelLot: card.querySelector('.prod-label-lot').value,
                        bagNo: card.querySelector('.prod-bag-no').value,
                        initialProductionQty: prodQty,
                        notes: card.querySelector('.prod-notes').value,
                        attendance: attendanceData ? JSON.parse(attendanceData) : [],
                        testSample: card.querySelector('.prod-test-sample').value,
                        loss: card.querySelector('.prod-loss').value,
                    });
                }
            });

            if (allJobs.length === 0) {
                hideLoader();
                showAlert(translations[currentLang].alert_error, translations[currentLang].alert_no_prod_data);
                return;
            }

            // # 2. 데이터를 그룹화 (날짜, 업체명, 품명, GRADE, 라벨LOT 기준)
            const groupedJobs = allJobs.reduce((acc, job) => {
                const key = `${job.client}|${job.itemName}|${job.grade}|${job.labelLot}`;
                if (!acc[key]) {
                    acc[key] = {
                        date: commonDate,
                        client: job.client,
                        itemName: job.itemName,
                        grade: job.grade,
                        labelLot: job.labelLot,
                        totalProductionQty: 0,
                        author: currentUsername,
                        createdAt: new Date(),
                        sourceJobs: []
                    };
                }
                acc[key].totalProductionQty += job.initialProductionQty;
                acc[key].sourceJobs.push(job);
                return acc;
            }, {});

            // # 3. Firestore에 저장 또는 업데이트
            const batch = writeBatch(db);
            const editingDocId = document.getElementById('editing-doc-id').value;

            try {
                if (editingDocId) { // 수정 모드
                    // 수정 모드에서는 그룹이 하나만 존재해야 함
                    const updatedData = Object.values(groupedJobs)[0];
                    if (!updatedData) throw new Error("수정할 데이터가 없습니다.");
                    updatedData.totalCurrentStock = updatedData.totalProductionQty; // 재고는 총 생산량으로 재계산
                    updatedData.lastModifiedBy = currentUsername;
                    updatedData.modifiedAt = new Date();
                    const docRef = doc(db, "production_aggregated", editingDocId);
                    batch.update(docRef, updatedData);
                } else { // 신규 저장 모드
                    Object.values(groupedJobs).forEach(group => {
                        group.totalCurrentStock = group.totalProductionQty;
                        const docRef = doc(collection(db, "production_aggregated"));
                        batch.set(docRef, group);
                    });
                }

                await batch.commit();
                showAlert(translations[currentLang].alert_success, translations[currentLang].alert_saved);
                document.getElementById('clear-all-prod-forms-btn').click();
                showMainContentPage('list-page');
            } catch (error) {
                showAlert(translations[currentLang].alert_error, error.message);
            } finally {
                hideLoader();
            }
        });
        
        // # 직원 관리
        document.getElementById('add-employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('employee-name');
            const name = nameInput.value.trim();
            if (name) {
                await addDoc(collection(db, 'employees'), { name });
                nameInput.value = '';
            }
        });

        const loadEmployees = () => {
            const employeeListDiv = document.getElementById('employee-list');
            onSnapshot(collection(db, 'employees'), (snapshot) => {
                allEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                employeeListDiv.innerHTML = '';
                allEmployees.forEach(emp => {
                    const empDiv = document.createElement('div');
                    empDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                    empDiv.innerHTML = `
                        <span>${emp.name}</span>
                        <button class="delete-employee-btn text-red-500 hover:text-red-700" data-id="${emp.id}"><i class="fas fa-times-circle"></i></button>
                    `;
                    empDiv.querySelector('.delete-employee-btn').addEventListener('click', () => deleteEmployee(emp.id));
                    employeeListDiv.appendChild(empDiv);
                });
            });
        };
        
        document.getElementById('go-to-employee-page-btn').addEventListener('click', () => showMainContentPage('employee-page'));

        const deleteEmployee = async (id) => {
            if (confirm('이 직원을 삭제하시겠습니까?')) {
                await deleteDoc(doc(db, 'employees', id));
            }
        };

        // # 직원 선택 모달 열기
        const openEmployeeSelectModal = (shift) => {
            currentEditingAttendanceShift = shift;
            const hiddenInput = document.getElementById(`prod-common-attendance-${shift}`);
            const selectedData = hiddenInput.value;
            const selectedNames = selectedData ? JSON.parse(selectedData) : [];
            
            const listContainer = document.getElementById('employee-select-list');
            listContainer.innerHTML = '';
            
            allEmployees.forEach(emp => {
                const isSelected = selectedNames.includes(emp.name);
                const button = document.createElement('button');
                button.textContent = emp.name;
                button.dataset.name = emp.name;
                button.className = `p-2 rounded border text-center cursor-pointer ${isSelected ? 'bg-indigo-600 text-white' : 'bg-white'}`;
                button.addEventListener('click', () => {
                    button.classList.toggle('bg-indigo-600');
                    button.classList.toggle('text-white');
                    button.classList.toggle('bg-white');
                });
                listContainer.appendChild(button);
            });
            document.getElementById('employee-select-modal').style.display = 'flex';
        };

        // # 직원 선택 저장
        document.getElementById('save-employee-select-btn').addEventListener('click', () => {
            if (!currentEditingAttendanceShift) return;

            const selectedButtons = document.querySelectorAll('#employee-select-list button.bg-indigo-600');
            const selectedNames = Array.from(selectedButtons).map(btn => btn.dataset.name);
            
            const displayArea = document.querySelector(`.attendance-display-area[data-shift="${currentEditingAttendanceShift}"]`);
            displayArea.innerHTML = '';
            if (selectedNames.length > 0) {
                selectedNames.forEach(name => {
                    const tag = document.createElement('span');
                    tag.className = 'bg-indigo-100 text-indigo-800 text-sm font-medium px-2.5 py-0.5 rounded';
                    tag.textContent = name;
                    displayArea.appendChild(tag);
                });
            } else {
                const shiftKey = `shift_${currentEditingAttendanceShift}`;
                displayArea.innerHTML = `<span class="text-gray-400 text-sm attendance-placeholder" data-lang-key="${shiftKey}">${translations[currentLang][shiftKey]}</span>`;
            }
            
            document.getElementById(`prod-common-attendance-${currentEditingAttendanceShift}`).value = JSON.stringify(selectedNames);
            document.getElementById('employee-select-modal').style.display = 'none';
        });

        document.getElementById('cancel-employee-select-btn').addEventListener('click', () => {
            document.getElementById('employee-select-modal').style.display = 'none';
        });

        document.querySelectorAll('.attendance-display-area').forEach(area => {
            area.addEventListener('click', () => openEmployeeSelectModal(area.dataset.shift));
        });


        // # 목록 필터링
        const applyFilters = () => {
            loadProductionData();
            loadInboundData();
            loadOutboundData();
        };
        document.getElementById('filter-date').addEventListener('change', applyFilters);
        document.getElementById('filter-client').addEventListener('input', applyFilters);
        document.getElementById('filter-lot').addEventListener('input', applyFilters);
        document.getElementById('filter-reset-btn').addEventListener('click', () => {
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-client').value = '';
            document.getElementById('filter-lot').value = '';
            applyFilters();
        });


        // # 생산 데이터 불러오기 및 렌더링
        let productionUnsubscribe;
        const loadProductionData = () => {
            if (productionUnsubscribe) productionUnsubscribe();
            
            const prodCollection = collection(db, "production_aggregated");
            productionUnsubscribe = onSnapshot(query(prodCollection), (querySnapshot) => {
                availableProductionStock = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(item => item.totalCurrentStock > 0);

                const filterDate = document.getElementById('filter-date').value;
                const filterClient = document.getElementById('filter-client').value.toLowerCase();
                const filterLot = document.getElementById('filter-lot').value.toLowerCase();

                const listBody = document.getElementById('production-list-body');
                listBody.innerHTML = '';
                let monthlyTotal = 0;
                const currentMonth = new Date().toISOString().slice(0, 7);

                let docs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                docs = docs.filter(data => {
                    const matchDate = !filterDate || data.date === filterDate;
                    const matchClient = !filterClient || (data.client && data.client.toLowerCase().includes(filterClient));
                    const matchLot = !filterLot || (data.labelLot && data.labelLot.toLowerCase().includes(filterLot));
                    return matchDate && matchClient && matchLot;
                });
                
                docs.sort((a, b) => new Date(b.date) - new Date(a.date));

                docs.forEach(data => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border-b p-3">${data.date || ''}</td>
                        <td class="border-b p-3">${data.client || ''}</td>
                        <td class="border-b p-3">${data.grade || ''}</td>
                        <td class="border-b p-3">${data.labelLot || ''}</td>
                        <td class="border-b p-3 text-right">${(data.totalProductionQty || 0).toLocaleString()}</td>
                        <td class="border-b p-3 font-bold text-blue-600 text-right">${(data.totalCurrentStock || 0).toLocaleString()}</td>
                        <td class="border-b p-3">${data.author || 'N/A'}</td>
                        <td class="border-b p-3 text-center">
                            <button class="edit-prod-btn text-blue-500 hover:text-blue-700 p-1" data-id="${data.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-prod-btn text-red-500 hover:text-red-700 p-1" data-id="${data.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    listBody.appendChild(row);
                    
                    if (data.date && data.date.startsWith(currentMonth)) {
                        monthlyTotal += Number(data.totalProductionQty || 0);
                    }
                });
                document.getElementById('monthly-total-production').innerText = monthlyTotal.toLocaleString();
            });
        };
        
        // # 생산 목록의 수정/삭제 버튼 이벤트 위임
        document.getElementById('production-list-body').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (target && target.classList.contains('delete-prod-btn')) {
                confirmDelete(target.dataset.id, 'production_aggregated');
            }
            if (target && target.classList.contains('edit-prod-btn')) {
                populateProductionFormForEdit(target.dataset.id);
            }
        });

        // # 수정 모드를 위해 생산 폼 채우기
        const populateProductionFormForEdit = async (docId) => {
            showLoader();
            try {
                const docRef = doc(db, "production_aggregated", docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 폼 초기화 및 수정 ID 설정
                    document.getElementById('clear-all-prod-forms-btn').click();
                    document.getElementById('editing-doc-id').value = docId;

                    // 공통 정보 채우기
                    document.getElementById('prod-common-date').value = data.date;
                    const dayAttendance = data.sourceJobs.find(j => j.shift === '주간')?.attendance || [];
                    const nightAttendance = data.sourceJobs.find(j => j.shift === '야간')?.attendance || [];
                    
                    document.getElementById('prod-common-attendance-day').value = JSON.stringify(dayAttendance);
                    document.getElementById('prod-common-attendance-night').value = JSON.stringify(nightAttendance);
                    // UI 업데이트
                    updateAttendanceDisplay('day', dayAttendance);
                    updateAttendanceDisplay('night', nightAttendance);

                    // 각 작업 카드 복원
                    data.sourceJobs.forEach((job, index) => {
                        const { machine, shift } = job;
                        const shiftKey = shift === '주간' ? 'day' : 'night';
                        const jobsContainer = document.getElementById(`machine-${machine}-${shiftKey}-jobs`);
                        
                        let card = jobsContainer.querySelector(`.prod-form-card[data-job-index="${index + 1}"]`);
                        if (!card) {
                            jobsContainer.insertAdjacentHTML('beforeend', createJobCardHTML(machine, shiftKey, index + 1));
                            card = jobsContainer.lastElementChild;
                        }
                        
                        // 카드에 데이터 채우기
                        const fieldMapping = {
                            client: 'prod-client', itemName: 'prod-item-name', grade: 'prod-grade',
                            mixLot: 'prod-mix-lot', mesh: 'prod-mesh', packagingCondition: 'prod-packaging-condition',
                            temperature: 'prod-temp', labelLot: 'prod-label-lot', bagNo: 'prod-bag-no',
                            initialProductionQty: 'prod-qty', notes: 'prod-notes', testSample: 'prod-test-sample', loss: 'prod-loss'
                        };
                        for (const [key, className] of Object.entries(fieldMapping)) {
                            const input = card.querySelector(`.${className}`);
                            if (input) input.value = job[key] || '';
                        }
                    });

                    showMainContentPage('production-page');
                } else {
                    showAlert(translations[currentLang].alert_error, "수정할 데이터를 찾을 수 없습니다.");
                }
            } catch (error) {
                showAlert(translations[currentLang].alert_error, error.message);
            } finally {
                hideLoader();
            }
        };
        
        const updateAttendanceDisplay = (shift, names) => {
            const displayArea = document.querySelector(`.attendance-display-area[data-shift="${shift}"]`);
            displayArea.innerHTML = '';
            if (names && names.length > 0) {
                names.forEach(name => {
                    const tag = document.createElement('span');
                    tag.className = 'bg-indigo-100 text-indigo-800 text-sm font-medium px-2.5 py-0.5 rounded';
                    tag.textContent = name;
                    displayArea.appendChild(tag);
                });
            } else {
                const shiftKey = `shift_${shift}`;
                displayArea.innerHTML = `<span class="text-gray-400 text-sm attendance-placeholder" data-lang-key="${shiftKey}">${translations[currentLang][shiftKey]}</span>`;
            }
        };


        // # 삭제 확인 모달
        let itemToDelete = { id: null, collection: null };
        const confirmDelete = (id, collectionName) => {
            itemToDelete = { id, collectionName };
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        };
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        });
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (itemToDelete.id && itemToDelete.collectionName) {
                showLoader();
                try {
                    await deleteDoc(doc(db, itemToDelete.collectionName, itemToDelete.id));
                    showAlert(translations[currentLang].alert_success, translations[currentLang].alert_deleted);
                } catch (error) {
                    showAlert(translations[currentLang].alert_error, error.message);
                } finally {
                    document.getElementById('delete-confirm-modal').style.display = 'none';
                    hideLoader();
                }
            }
        });
        
        // # 입/출고를 위한 아이템 목록 불러오기
        const loadItemsForOutbound = () => {
            const inboundSelect = document.getElementById('outbound-inbound-item-select');
            onSnapshot(collection(db, "inventory_in"), (snapshot) => {
                inboundSelect.innerHTML = `<option value="">--- ${translations[currentLang].form_select_inbound_item} ---</option>`;
                snapshot.docs
                    .filter(doc => doc.data().currentStockQty > 0)
                    .sort((a,b) => new Date(b.data().inboundDate) - new Date(a.data().inboundDate))
                    .forEach(doc => {
                        const data = doc.data();
                        inboundSelect.innerHTML += `<option value="${doc.id}">${data.inboundDate} / ${data.itemName} / ${data.client} (재고: ${data.currentStockQty})</option>`;
                    });
            });
        };
        
        // # 외부 입고 처리
        document.getElementById('inbound-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            const data = {
                inboundDate: document.getElementById('inbound-date').value,
                client: document.getElementById('inbound-client').value,
                itemName: document.getElementById('inbound-item').value,
                initialInboundQty: Number(document.getElementById('inbound-qty').value),
                author: currentUsername,
                createdAt: new Date(),
            };

            if (!data.inboundDate || !data.client || !data.itemName || !data.initialInboundQty) {
                 hideLoader();
                 showAlert(translations[currentLang].alert_error, translations[currentLang].alert_fill_all_fields);
                return;
            }
            data.currentStockQty = data.initialInboundQty;
            data.outboundHistory = [];

            try {
                await addDoc(collection(db, "inventory_in"), data);
                showAlert(translations[currentLang].alert_success, translations[currentLang].alert_inbound_added);
                e.target.reset();
            } catch (error) {
                showAlert(translations[currentLang].alert_error, error.message);
            } finally {
                hideLoader();
            }
        });

        // # 생산품 출고 처리 로직
        const addOutboundItemRow = () => {
            const container = document.getElementById('outbound-items-container');
            const t = translations[currentLang];
            const uniqueItemNames = [...new Set(availableProductionStock.map(item => item.itemName))];

            const itemRow = document.createElement('div');
            itemRow.className = 'outbound-item-row border p-3 rounded-md space-y-2 relative';
            itemRow.innerHTML = `
                <button type="button" class="delete-outbound-item-btn absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                <div class="grid grid-cols-3 items-center gap-2">
                    <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_item_name}</label>
                    <div class="col-span-2">
                        <select class="form-input outbound-item-name">
                            <option value="">--- ${t.select_item} ---</option>
                            ${uniqueItemNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_client} + ${t.form_grade}</label>
                    <div class="col-span-2"><select class="form-input outbound-client-grade" disabled><option value="">--- ${t.select_client_grade} ---</option></select></div>
                    <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_label_lot}</label>
                    <div class="col-span-2"><select class="form-input outbound-lot" disabled><option value="">--- ${t.select_lot} ---</option></select></div>
                    <label class="col-span-1 font-semibold text-sm text-right pr-2">${t.form_outbound_qty}</label>
                    <div class="col-span-2"><input type="number" class="form-input text-right outbound-qty" required></div>
                </div>
            `;
            container.appendChild(itemRow);
        };
        
        document.getElementById('add-outbound-item-btn').addEventListener('click', addOutboundItemRow);
        
        document.getElementById('outbound-items-container').addEventListener('change', (e) => {
            const row = e.target.closest('.outbound-item-row');
            if (!row) return;

            const itemNameSelect = row.querySelector('.outbound-item-name');
            const clientGradeSelect = row.querySelector('.outbound-client-grade');
            const lotSelect = row.querySelector('.outbound-lot');

            if (e.target === itemNameSelect) {
                const selectedItem = itemNameSelect.value;
                clientGradeSelect.innerHTML = `<option value="">--- ${translations[currentLang].select_client_grade} ---</option>`;
                lotSelect.innerHTML = `<option value="">--- ${translations[currentLang].select_lot} ---</option>`;
                clientGradeSelect.disabled = true;
                lotSelect.disabled = true;

                if (selectedItem) {
                    const filtered = availableProductionStock.filter(item => item.itemName === selectedItem);
                    const clientGrades = [...new Set(filtered.map(item => `${item.client}|${item.grade}`))];
                    clientGrades.forEach(cg => {
                        const [client, grade] = cg.split('|');
                        clientGradeSelect.innerHTML += `<option value="${cg}">${client} + ${grade}</option>`;
                    });
                    clientGradeSelect.disabled = false;
                }
            }

            if (e.target === clientGradeSelect) {
                const selectedItem = itemNameSelect.value;
                const [selectedClient, selectedGrade] = clientGradeSelect.value.split('|');
                lotSelect.innerHTML = `<option value="">--- ${translations[currentLang].select_lot} ---</option>`;
                lotSelect.disabled = true;

                if (selectedClient && selectedGrade) {
                    const filtered = availableProductionStock.filter(item => item.itemName === selectedItem && item.client === selectedClient && item.grade === selectedGrade);
                    filtered.forEach(item => {
                        lotSelect.innerHTML += `<option value="${item.id}">${item.labelLot} (재고: ${item.totalCurrentStock})</option>`;
                    });
                    lotSelect.disabled = false;
                }
            }
        });

        document.getElementById('outbound-items-container').addEventListener('click', (e) => {
            if (e.target.closest('.delete-outbound-item-btn')) {
                e.target.closest('.outbound-item-row').remove();
            }
        });

        document.getElementById('outbound-prod-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('outbound-prod-date').value;
            if (!date) {
                showAlert(translations[currentLang].alert_error, "출고일을 입력해주세요.");
                return;
            }

            const rows = document.querySelectorAll('#outbound-items-container .outbound-item-row');
            if (rows.length === 0) {
                showAlert(translations[currentLang].alert_error, "출고할 항목을 추가해주세요.");
                return;
            }

            showLoader();
            const batch = writeBatch(db);
            let isValid = true;
            const updates = [];

            for (const row of rows) {
                const docId = row.querySelector('.outbound-lot').value;
                const qty = Number(row.querySelector('.outbound-qty').value);
                if (!docId || !qty || qty <= 0) {
                    isValid = false;
                    break;
                }
                updates.push({ docId, qty });
            }

            if (!isValid) {
                hideLoader();
                showAlert(translations[currentLang].alert_error, "모든 출고 항목의 정보를 올바르게 입력해주세요.");
                return;
            }

            try {
                for (const update of updates) {
                    const docRef = doc(db, "production_aggregated", update.docId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.totalCurrentStock < update.qty) {
                            throw new Error(`${data.labelLot}의 재고가 부족합니다.`);
                        }
                        const newStock = data.totalCurrentStock - update.qty;
                        const newHistory = [...(data.outboundHistory || []), { date, qty: update.qty, user: currentUsername }];
                        batch.update(docRef, { totalCurrentStock: newStock, outboundHistory: newHistory });
                    }
                }
                await batch.commit();
                showAlert(translations[currentLang].alert_success, translations[currentLang].alert_outbound_processed);
                document.getElementById('outbound-items-container').innerHTML = '';
                addOutboundItemRow();
            } catch (error) {
                showAlert(translations[currentLang].alert_error, error.message);
            } finally {
                hideLoader();
            }
        });


        // # 입고품 출고 처리
        document.getElementById('outbound-inbound-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            const docId = document.getElementById('outbound-inbound-item-select').value;
            const qty = Number(document.getElementById('outbound-inbound-qty').value);
            const date = document.getElementById('outbound-inbound-date').value;
            const purpose = document.getElementById('outbound-inbound-purpose').value;

            if (!docId || !qty || qty <= 0 || !date || !purpose) {
                hideLoader();
                showAlert(translations[currentLang].alert_error, translations[currentLang].alert_fill_all_fields);
                return;
            }
            
            const docRef = doc(db, "inventory_in", docId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.currentStockQty < qty) {
                        hideLoader();
                        showAlert(translations[currentLang].alert_error, translations[currentLang].alert_stock_insufficient);
                        return;
                    }
                    const newStock = data.currentStockQty - qty;
                    const newHistory = [...(data.outboundHistory || []), { date, qty, purpose, user: currentUsername }];
                    await updateDoc(docRef, { currentStockQty: newStock, outboundHistory: newHistory });
                    showAlert(translations[currentLang].alert_success, translations[currentLang].alert_outbound_processed);
                    e.target.reset();
                }
            } catch(error) {
                showAlert(translations[currentLang].alert_error, error.message);
            } finally {
                hideLoader();
            }
        });

        // # 입고 데이터 불러오기
        let inboundUnsubscribe;
        const loadInboundData = () => {
            if (inboundUnsubscribe) inboundUnsubscribe();
            
            const inboundCollection = collection(db, "inventory_in");
            
            inboundUnsubscribe = onSnapshot(query(inboundCollection), (querySnapshot) => {
                const filterDate = document.getElementById('filter-date').value;
                const filterClient = document.getElementById('filter-client').value.toLowerCase();
                
                const listBody = document.getElementById('inbound-list-body');
                listBody.innerHTML = '';

                let docs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                docs = docs.filter(data => {
                    const matchDate = !filterDate || data.inboundDate === filterDate;
                    const matchClient = !filterClient || (data.client && data.client.toLowerCase().includes(filterClient));
                    return matchDate && matchClient;
                });
                
                docs.sort((a, b) => new Date(b.inboundDate) - new Date(a.inboundDate));

                docs.forEach(data => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border-b p-3">${data.inboundDate || ''}</td>
                        <td class="border-b p-3">${data.client || ''}</td>
                        <td class="border-b p-3">${data.itemName || ''}</td>
                        <td class="border-b p-3 text-right">${(data.initialInboundQty || 0).toLocaleString()}</td>
                        <td class="border-b p-3 font-bold text-blue-600 text-right">${(data.currentStockQty || 0).toLocaleString()}</td>
                        <td class="border-b p-3">${data.author || 'N/A'}</td>
                        <td class="border-b p-3 text-center">
                            <button class="delete-inbound-btn text-red-500 hover:text-red-700 p-1" data-id="${data.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    listBody.appendChild(row);
                });
            });
        };

        // # 입고 목록 삭제 버튼 이벤트 위임
        document.getElementById('inbound-list-body').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (target && target.classList.contains('delete-inbound-btn')) {
                confirmDelete(target.dataset.id, 'inventory_in');
            }
        });
        
        // # 출고 데이터 불러오기
        let prodOutboundUnsubscribe;
        let inboundOutboundUnsubscribe;
        const loadOutboundData = () => {
            if (prodOutboundUnsubscribe) prodOutboundUnsubscribe();
            if (inboundOutboundUnsubscribe) inboundOutboundUnsubscribe();

            const filterDate = document.getElementById('filter-date').value;
            const filterClient = document.getElementById('filter-client').value.toLowerCase();
            const filterLot = document.getElementById('filter-lot').value.toLowerCase();

            // 1. Load Production Outbound History
            const prodCollection = collection(db, "production_aggregated");
            prodOutboundUnsubscribe = onSnapshot(query(prodCollection), (querySnapshot) => {
                const listBody = document.getElementById('prod-outbound-list-body');
                let allOutboundEvents = [];

                querySnapshot.docs.forEach(doc => {
                    const docData = doc.data();
                    if (docData.outboundHistory && Array.isArray(docData.outboundHistory)) {
                        docData.outboundHistory.forEach(historyItem => {
                            allOutboundEvents.push({
                                ...historyItem,
                                itemName: docData.itemName,
                                client: docData.client,
                                labelLot: docData.labelLot,
                            });
                        });
                    }
                });

                const filteredEvents = allOutboundEvents.filter(event => {
                    const matchDate = !filterDate || event.date === filterDate;
                    const matchClient = !filterClient || (event.client && event.client.toLowerCase().includes(filterClient));
                    const matchLot = !filterLot || (event.labelLot && event.labelLot.toLowerCase().includes(filterLot));
                    return matchDate && matchClient && matchLot;
                });

                filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

                listBody.innerHTML = '';
                filteredEvents.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border-b p-3">${event.date || ''}</td>
                        <td class="border-b p-3">${event.itemName || ''}</td>
                        <td class="border-b p-3">${event.client || ''}</td>
                        <td class="border-b p-3">${event.labelLot || ''}</td>
                        <td class="border-b p-3 text-right">${(event.qty || 0).toLocaleString()}</td>
                        <td class="border-b p-3">${event.user || 'N/A'}</td>
                    `;
                    listBody.appendChild(row);
                });
            });

            // 2. Load Inbound Items Outbound History
            const inboundCollection = collection(db, "inventory_in");
            inboundOutboundUnsubscribe = onSnapshot(query(inboundCollection), (querySnapshot) => {
                const listBody = document.getElementById('inbound-outbound-list-body');
                let allOutboundEvents = [];

                querySnapshot.docs.forEach(doc => {
                    const docData = doc.data();
                    if (docData.outboundHistory && Array.isArray(docData.outboundHistory)) {
                        docData.outboundHistory.forEach(historyItem => {
                            allOutboundEvents.push({
                                ...historyItem,
                                itemName: docData.itemName,
                                client: docData.client,
                            });
                        });
                    }
                });

                const filteredEvents = allOutboundEvents.filter(event => {
                    const matchDate = !filterDate || event.date === filterDate;
                    const matchClient = !filterClient || (event.client && event.client.toLowerCase().includes(filterClient));
                    return matchDate && matchClient;
                });

                filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

                listBody.innerHTML = '';
                filteredEvents.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border-b p-3">${event.date || ''}</td>
                        <td class="border-b p-3">${event.itemName || ''}</td>
                        <td class="border-b p-3">${event.client || ''}</td>
                        <td class="border-b p-3 text-right">${(event.qty || 0).toLocaleString()}</td>
                        <td class="border-b p-3">${event.purpose || ''}</td>
                        <td class="border-b p-3">${event.user || 'N/A'}</td>
                    `;
                    listBody.appendChild(row);
                });
            });
        };

        // # 목록 페이지 탭 전환
        document.querySelectorAll('.list-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.list-tab-btn').forEach(b => {
                    b.classList.remove('active-tab');
                    b.classList.add('text-gray-500', 'hover:text-gray-700');
                });
                btn.classList.add('active-tab');
                btn.classList.remove('text-gray-500', 'hover:text-gray-700');
                
                document.querySelectorAll('.list-container').forEach(container => container.style.display = 'none');
                document.getElementById(btn.dataset.target).style.display = 'block';
            });
        });

        // # 입/출고 페이지 탭 전환
        document.querySelectorAll('.inventory-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.inventory-tab-btn').forEach(b => {
                    b.classList.remove('active-tab');
                    b.classList.add('text-gray-500', 'hover:text-gray-700');
                });
                btn.classList.add('active-tab');
                btn.classList.remove('text-gray-500', 'hover:text-gray-700');
                
                document.querySelectorAll('.inventory-section').forEach(section => section.style.display = 'none');
                document.getElementById(btn.dataset.target).style.display = 'block';
            });
        });

        // # 앱 초기화 및 익명 로그인
        const initializeAppAndAuth = async () => {
            showLoader();
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
                createProductionForms();
                addOutboundItemRow(); // 출고 페이지에 기본 한 줄 추가
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                showAlert("인증 오류", "서비스에 연결할 수 없습니다. 페이지를 새로고침 해주세요.");
            } finally {
                hideLoader();
            }
        };

        // 초기 언어 설정 및 앱 시작
        setLanguage('ko');
        initializeAppAndAuth();

    </script>
</body>
</html>
