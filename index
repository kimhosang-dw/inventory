<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒì‚°/ì¬ê³  ê´€ë¦¬ í”„ë¡œê·¸ë¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .section-hidden { display: none; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ì „ì²´ ì»¨í…Œì´ë„ˆ -->
    <div id="app-container" class="max-w-7xl mx-auto p-4">

        <!-- ì‚¬ìš©ìëª… ì…ë ¥ í™”ë©´ -->
        <div id="user-selection-screen">
            <div class="min-h-screen flex items-center justify-center">
                <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-md">
                    <h1 class="text-2xl font-bold mb-2" data-lang-key="welcome_title">ìƒì‚°/ì¬ê³  ê´€ë¦¬ í”„ë¡œê·¸ë¨</h1>
                    <p class="text-gray-600 mb-6" data-lang-key="welcome_subtitle">ë°ì´í„° ì‘ì„±ì„ ìœ„í•´ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    <input type="text" id="username-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <button id="start-app-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mt-4 hover:bg-blue-700 transition-colors" data-lang-key="start_button">ì‹œì‘í•˜ê¸°</button>
                </div>
            </div>
        </div>
        
        <!-- ê³µí†µ í—¤ë” -->
        <header id="app-header" class="bg-white p-4 rounded-xl shadow-md mb-6 justify-between items-center section-hidden">
            <div class="flex items-center">
                <button id="back-to-menu-btn" class="p-2 rounded-full hover:bg-gray-100 mr-4 section-hidden">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1 id="page-header-title" class="text-2xl font-bold text-gray-800"></h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="header-user-display" class="text-gray-600 font-semibold"></span>
                <div class="relative">
                    <select id="language-select" class="bg-gray-200 border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2">
                        <option value="ko">ì–¸ì–´ : í•œêµ­ì–´</option>
                        <option value="si">ì–¸ì–´ : à·ƒà·’à¶‚à·„à¶½</option>
                    </select>
                </div>
                <button id="logout-btn" class="bg-red-500 text-white px-3 py-2 rounded-md text-sm hover:bg-red-600" data-lang-key="logout">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <!-- ë©”ì¸ ë©”ë‰´ í™”ë©´ -->
        <div id="main-menu-screen" class="section-hidden">
             <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-800" data-lang-key="main_menu_title">ë©”ì¸ ë©”ë‰´</h1>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 w-full max-w-6xl mx-auto">
                 <button class="main-menu-btn p-8 bg-white rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all" data-target="work-order-section">
                     <h2 class="text-2xl font-bold text-green-600" data-lang-key="nav_work_order">ì‘ì—…ì§€ì‹œì„œ</h2>
                     <p class="text-gray-500 mt-2" data-lang-key="menu_work_order_desc">ê´€ë¦¬ìê°€ ì‘ì—… ë‚´ìš©ì„ ì§€ì‹œí•©ë‹ˆë‹¤.</p>
                 </button>
                 <button class="main-menu-btn p-8 bg-white rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all" data-target="production-input-section">
                     <h2 class="text-2xl font-bold text-orange-600" data-lang-key="nav_production_input">ìƒì‚°ëŸ‰ ì…ë ¥</h2>
                     <p class="text-gray-500 mt-2" data-lang-key="menu_production_input_desc">ê·¼ë¡œìê°€ ìƒì‚° ì‹¤ì ì„ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                 </button>
                 <button class="main-menu-btn p-8 bg-white rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all" data-target="inventory-section">
                     <h2 class="text-2xl font-bold text-blue-600" data-lang-key="nav_inventory">ì…ê³ /ì¶œê³ </h2>
                     <p class="text-gray-500 mt-2" data-lang-key="menu_inventory_desc">ì›ì¬ë£Œ ë° ìƒì‚°í’ˆì˜ ì…ì¶œê³ ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                 </button>
                 <button class="main-menu-btn p-8 bg-white rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all" data-target="list-section">
                     <h2 class="text-2xl font-bold text-purple-600" data-lang-key="nav_list">ëª©ë¡</h2>
                     <p class="text-gray-500 mt-2" data-lang-key="menu_list_desc">ì „ì²´ ì¬ê³  í˜„í™© ë° ê¸°ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
                 </button>
             </div>
        </div>

        <!-- ê¸°ëŠ¥ í˜ì´ì§€ ë˜í¼ -->
        <div id="page-wrapper" class="section-hidden">
            <div id="page-content">
                <!-- ì‘ì—…ì§€ì‹œì„œ -->
                <main id="work-order-section" class="section-hidden space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex justify-end">
                        <button id="save-work-order-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700" data-lang-key="save_work_order">ì‘ì—…ì§€ì‹œì„œ ì €ì¥</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center mb-4">
                            <h2 class="text-xl font-bold" data-lang-key="attendance_header">ê·¼íƒœ</h2>
                            <button id="manage-worker-btn" class="ml-4 bg-gray-200 text-sm px-4 py-2 rounded-md hover:bg-gray-300" data-lang-key="manage_workers_btn">ê·¼ë¬´ì ê´€ë¦¬</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700" data-lang-key="day_workers">ì£¼ê°„ ê·¼ë¬´ì</label>
                                    <button class="add-attendance-btn text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md" data-shift="day">+ ê·¼ë¬´ì ì¶”ê°€</button>
                                </div>
                                <div id="day-worker-attendance-list" class="space-y-3 mt-2 p-2 border rounded-md min-h-[100px]"></div>
                            </div>
                             <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700" data-lang-key="night_workers">ì•¼ê°„ ê·¼ë¬´ì</label>
                                    <button class="add-attendance-btn text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md" data-shift="night">+ ê·¼ë¬´ì ì¶”ê°€</button>
                                </div>
                                <div id="night-worker-attendance-list" class="space-y-3 mt-2 p-2 border rounded-md min-h-[100px]"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div>
                                <label for="wo-date" class="block text-sm font-medium text-gray-700" data-lang-key="date">ë‚ ì§œ</label>
                                <input type="date" id="wo-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                           </div>
                             <div class="md:col-span-2">
                               <label for="wo-handover-notes" class="block text-sm font-medium text-gray-700" data-lang-key="handover_notes">ì „ë‹¬ì‚¬í•­</label>
                               <textarea id="wo-handover-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                           </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                            <h3 class="text-lg font-bold text-green-600" data-lang-key="day_shift">â˜€ï¸ ì£¼ê°„</h3>
                             <div class="space-y-4">
                                <div class="border border-green-200 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800" data-lang-key="machine_1">1í˜¸ê¸°</h4>
                                    <div id="wo-day-m1-entries" class="space-y-4 mt-2"></div>
                                    <button class="add-entry-btn mt-2 bg-green-100 text-green-800 px-3 py-1 rounded-md w-full text-sm hover:bg-green-200" data-shift="day" data-machine="1" data-lang-key="add_machine_entry">+ 1í˜¸ê¸° ìƒì‚° ì¶”ê°€</button>
                                </div>
                                <div class="border border-green-200 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800" data-lang-key="machine_2">2í˜¸ê¸°</h4>
                                    <div id="wo-day-m2-entries" class="space-y-4 mt-2"></div>
                                    <button class="add-entry-btn mt-2 bg-green-100 text-green-800 px-3 py-1 rounded-md w-full text-sm hover:bg-green-200" data-shift="day" data-machine="2" data-lang-key="add_machine_entry">+ 2í˜¸ê¸° ìƒì‚° ì¶”ê°€</button>
                                </div>
                                <div class="border border-green-200 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800" data-lang-key="machine_3">3í˜¸ê¸°</h4>
                                    <div id="wo-day-m3-entries" class="space-y-4 mt-2"></div>
                                    <button class="add-entry-btn mt-2 bg-green-100 text-green-800 px-3 py-1 rounded-md w-full text-sm hover:bg-green-200" data-shift="day" data-machine="3" data-lang-key="add_machine_entry">+ 3í˜¸ê¸° ìƒì‚° ì¶”ê°€</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-800 text-white p-6 rounded-xl shadow-md space-y-4">
                            <h3 class="text-lg font-bold text-yellow-400" data-lang-key="night_shift">ğŸŒ™ ì•¼ê°„</h3>
                             <div class="space-y-4">
                                <div class="border border-gray-600 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-300" data-lang-key="machine_1">1í˜¸ê¸°</h4>
                                    <div id="wo-night-m1-entries" class="space-y-4 mt-2"></div>
                                    <button class="add-entry-btn mt-2 bg-gray-700 text-white px-3 py-1 rounded-md w-full text-sm hover:bg-gray-600" data-shift="night" data-machine="1" data-lang-key="add_machine_entry">+ 1í˜¸ê¸° ìƒì‚° ì¶”ê°€</button>
                                </div>
                                <div class="border border-gray-600 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-300" data-lang-key="machine_2">2í˜¸ê¸°</h4>
                                    <div id="wo-night-m2-entries" class="space-y-4 mt-2"></div>
                                    <button class="add-entry-btn mt-2 bg-gray-700 text-white px-3 py-1 rounded-md w-full text-sm hover:bg-gray-600" data-shift="night" data-machine="2" data-lang-key="add_machine_entry">+ 2í˜¸ê¸° ìƒì‚° ì¶”ê°€</button>
                                </div>
                                <div class="border border-gray-600 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-300" data-lang-key="machine_3">3í˜¸ê¸°</h4>
                                    <div id="wo-night-m3-entries" class="space-y-4 mt-2"></div>
                                    <button class="add-entry-btn mt-2 bg-gray-700 text-white px-3 py-1 rounded-md w-full text-sm hover:bg-gray-600" data-shift="night" data-machine="3" data-lang-key="add_machine_entry">+ 3í˜¸ê¸° ìƒì‚° ì¶”ê°€</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                <!-- ìƒì‚°ëŸ‰ ì…ë ¥ -->
                <main id="production-input-section" class="section-hidden space-y-6">
                    <div id="work-order-list-view">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4">ì‘ì—…ì§€ì‹œì„œ ëª©ë¡</h2>
                            <div id="work-order-list-container" class="space-y-2"></div>
                        </div>
                    </div>
                    <div id="production-input-detail-view" class="section-hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <button id="back-to-wo-list-btn" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">ëª©ë¡ìœ¼ë¡œ</button>
                            <button id="save-production-input-btn" class="bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-orange-700" data-lang-key="save_production_input">ìƒì‚°ëŸ‰ ì €ì¥</button>
                        </div>
                        <div id="production-input-display" class="space-y-6">
                            <!-- ì‘ì—…ì§€ì‹œì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                        </div>
                    </div>
                </main>
                <main id="inventory-section" class="section-hidden"></main>
                <main id="list-section" class="section-hidden"></main>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ë° í…œí”Œë¦¿ë“¤ -->
    <div id="worker-modal" class="fixed inset-0 z-50 items-center justify-center section-hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md relative">
            <h3 class="text-lg font-bold mb-4" data-lang-key="manage_workers">ê·¼ë¬´ì ê´€ë¦¬</h3>
            <div class="flex mb-4">
                <input type="text" id="new-worker-input" class="flex-grow border rounded-l-md p-2" placeholder="ìƒˆ ê·¼ë¬´ì ì´ë¦„">
                <button id="add-worker-btn" class="bg-blue-500 text-white px-4 rounded-r-md hover:bg-blue-600" data-lang-key="add_button">ì¶”ê°€</button>
            </div>
            <div id="worker-list-modal" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button id="close-worker-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
    <div id="product-modal" class="fixed inset-0 z-50 items-center justify-center section-hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl relative">
            <h3 class="text-lg font-bold mb-4" data-lang-key="manage_products">ì œí’ˆ ì •ë³´ ê´€ë¦¬</h3>
            <input type="text" id="product-filter-input" class="w-full p-2 border rounded-md mb-4" placeholder="ì—…ì²´ëª…ìœ¼ë¡œ í•„í„°ë§...">
            <div id="product-list-container" class="space-y-2 max-h-96 overflow-y-auto"></div>
            <button id="close-product-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="worker-selection-modal" class="fixed inset-0 z-50 items-center justify-center section-hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md relative">
            <h3 class="text-lg font-bold mb-4" data-lang-key="select_workers">ê·¼ë¬´ì ì„ íƒ</h3>
            <div id="worker-selection-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="flex justify-end mt-4 space-x-2">
                 <button id="cancel-worker-selection-btn" class="bg-gray-200 px-4 py-2 rounded-md">ì·¨ì†Œ</button>
                 <button id="confirm-worker-selection-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 z-50 items-center justify-center section-hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm relative text-center">
            <p id="confirmation-message" class="text-lg mb-4"></p>
            <button id="close-confirmation-modal-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md">í™•ì¸</button>
        </div>
    </div>

    <template id="wo-entry-template">
        <div class="production-entry border rounded-lg p-4 space-y-4 relative bg-white text-gray-800">
            <div class="flex justify-end space-x-2 absolute top-2 right-2">
                <button class="copy-entry-to-night-btn bg-indigo-500 text-white px-2 py-1 rounded-md text-xs hover:bg-indigo-600" data-lang-key="copy_to_night">ì•¼ê°„ ë³µì‚¬</button>
                <button class="delete-entry-btn text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4">
                <div class="md:col-span-2 lg:col-span-4">
                    <div class="product-info-panel bg-gray-50 p-3 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold product-info-title" data-lang-key="product_info">ì œí’ˆ ì •ë³´</h4>
                            <div>
                                <button class="save-product-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-md" data-lang-key="save_product_spec">ì œí’ˆ ì‚¬ì–‘ ì €ì¥</button>
                                <button class="load-product-modal-btn text-xs bg-green-100 text-green-700 px-2 py-1 rounded-md" data-lang-key="load_product_spec">ì œí’ˆ ì‚¬ì–‘ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-2">
                            <div><label class="text-xs product-info-label" data-lang-key="client_name">ì—…ì²´ëª…</label><input type="text" class="prod-input client_name w-full text-sm p-1 border-b" placeholder="Aì‚¬"></div>
                            <div><label class="text-xs product-info-label" data-lang-key="item_name">í’ˆëª©</label><input type="text" class="prod-input item_name w-full text-sm p-1 border-b" placeholder="PET Flake"></div>
                            <div><label class="text-xs product-info-label" data-lang-key="grade">GRADE</label><input type="text" class="prod-input grade w-full text-sm p-1 border-b" placeholder="A"></div>
                            <div><label class="text-xs product-info-label" data-lang-key="mesh">ë§(Mesh)</label><input type="text" class="prod-input mesh w-full text-sm p-1 border-b" placeholder="120"></div>
                            <div class="col-span-2"><label class="text-xs product-info-label" data-lang-key="temp_condition">ì˜¨ë„ ì¡°ê±´</label>
                                <div class="flex items-center">
                                    <input type="number" class="prod-input temp_min w-full text-sm p-1 border-b" placeholder="280"> <span class="mx-1">~</span> <input type="number" class="prod-input temp_max w-full text-sm p-1 border-b" placeholder="300">â„ƒ
                                </div>
                            </div>
                            <div><label class="text-xs product-info-label" data-lang-key="pack_weight">í¬ì¥ì¤‘ëŸ‰(kg)</label><input type="number" class="prod-input pack_weight w-full text-sm p-1 border-b" placeholder="1000"></div>
                            <div><label class="text-xs product-info-label" data-lang-key="pack_spec">í¬ì¥ì‚¬ì–‘</label><input type="text" class="prod-input pack_spec w-full text-sm p-1 border-b" placeholder="bag"></div>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2"><label class="text-sm" data-lang-key="mix_lot">ë°°í•©LOT</label><input type="text" class="prod-input mix_lot w-full p-2 border rounded-md"></div>
                <div class="md:col-span-2"><label class="text-sm" data-lang-key="label_lot">ë¼ë²¨LOT</label><input type="text" class="prod-input label_lot w-full p-2 border rounded-md"></div>
                <div class="md:col-span-4"><label class="text-sm" data-lang-key="test_sample">TEST/SAMPLE</label><input type="text" class="prod-input test_sample w-full p-2 border rounded-md"></div>
                <div class="md:col-span-4"><label class="text-sm" data-lang-key="remarks">ë¹„ê³ </label><input type="text" class="prod-input remarks w-full p-2 border rounded-md"></div>
            </div>
        </div>
    </template>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, deleteDoc, updateDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBfpxEX8Orny65F-39gB3eikqddVqRjJW0",
                authDomain: "inventory-1cd47.firebaseapp.com",
                projectId: "inventory-1cd47",
                storageBucket: "inventory-1cd47.firebasestorage.app",
                messagingSenderId: "457081542611",
                appId: "1:457081542611:web:1c78706d660be49b32c126"
            };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let userId = null, userName = '', currentEditingProductEntry = null, allProducts = [], allWorkers = [];

        const translations = {
            ko: { welcome_title: "ìƒì‚°/ì¬ê³  ê´€ë¦¬ í”„ë¡œê·¸ë¨", welcome_subtitle: "ë°ì´í„° ì‘ì„±ì„ ìœ„í•´ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", start_button: "ì‹œì‘í•˜ê¸°", logout: "ë¡œê·¸ì•„ì›ƒ", main_menu_title: "ë©”ì¸ ë©”ë‰´", manage_workers_btn: "ê·¼ë¬´ì ê´€ë¦¬", nav_work_order: "ì‘ì—…ì§€ì‹œì„œ", menu_work_order_desc: "ê´€ë¦¬ìê°€ ì‘ì—… ë‚´ìš©ì„ ì§€ì‹œí•©ë‹ˆë‹¤.", nav_production_input: "ìƒì‚°ëŸ‰ ì…ë ¥", menu_production_input_desc: "ê·¼ë¡œìê°€ ìƒì‚° ì‹¤ì ì„ ì…ë ¥í•©ë‹ˆë‹¤.", nav_inventory: "ì…ê³ /ì¶œê³ ", menu_inventory_desc: "ì›ì¬ë£Œ ë° ìƒì‚°í’ˆì˜ ì…ì¶œê³ ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.", nav_list: "ëª©ë¡", menu_list_desc: "ì „ì²´ ì¬ê³  í˜„í™© ë° ê¸°ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.", attendance_header: "ê·¼íƒœ", day_workers: "ì£¼ê°„ ê·¼ë¬´ì", night_workers: "ì•¼ê°„ ê·¼ë¬´ì", work_hours: "ê·¼ë¬´ ì‹œê°„", date: "ë‚ ì§œ", handover_notes: "ì „ë‹¬ì‚¬í•­", day_shift: "â˜€ï¸ ì£¼ê°„", night_shift: "ğŸŒ™ ì•¼ê°„", machine_1: "1í˜¸ê¸°", machine_2: "2í˜¸ê¸°", machine_3: "3í˜¸ê¸°", add_machine_entry: "ìƒì‚° ì¶”ê°€", save_work_order: "ì‘ì—…ì§€ì‹œì„œ ì €ì¥", manage_workers: "ê·¼ë¬´ì ê´€ë¦¬", add_button: "ì¶”ê°€", delete_button: "ì‚­ì œ", confirm_delete: "ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", manage_products: "ì œí’ˆ ì •ë³´ ê´€ë¦¬", product_info: "ì œí’ˆ ì •ë³´", save_product_spec: "ì œí’ˆ ì‚¬ì–‘ ì €ì¥", load_product_spec: "ì œí’ˆ ì‚¬ì–‘ ë¶ˆëŸ¬ì˜¤ê¸°", client_name: "ì—…ì²´ëª…", item_name: "í’ˆëª©", grade: "GRADE", mesh: "ë§(Mesh)", temp_condition: "ì˜¨ë„ ì¡°ê±´", pack_weight: "í¬ì¥ì¤‘ëŸ‰(kg)", pack_spec: "í¬ì¥ì‚¬ì–‘", mix_lot: "ë°°í•©LOT", label_lot: "ë¼ë²¨LOT", bag_no: "BAG NO", prod_amount: "ìƒì‚°ëŸ‰(kg)", test_sample: "TEST/SAMPLE", loss_rate: "Lossìœ¨/ë–¡", remarks: "íŠ¹ì´ì‚¬í•­", load_work_order: "ì‘ì—…ì§€ì‹œì„œ ë¶ˆëŸ¬ì˜¤ê¸°", no_work_order: "í•´ë‹¹ ë‚ ì§œì— ì‘ì—…ì§€ì‹œì„œê°€ ì—†ìŠµë‹ˆë‹¤.", save_production_input: "ìƒì‚°ëŸ‰ ì €ì¥", copy_to_night: "ì•¼ê°„ ë³µì‚¬", select_workers: "ê·¼ë¬´ì ì„ íƒ" },
            si: { welcome_title: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à·ƒà·„ à¶‰à¶±à·Šà·€à·™à¶±à·Šà¶§à¶»à·’ à¶šà·…à¶¸à¶±à·à¶šà¶»à¶« à·€à·à¶©à·ƒà¶§à·„à¶±", welcome_subtitle: "à¶¯à¶­à·Šà¶­ à¶‡à¶­à·”à·…à¶­à·Š à¶šà·’à¶»à·“à¶¸à¶§ à¶šà¶»à·”à¶«à·à¶šà¶» à¶”à¶¶à·š à¶´à¶»à·’à·à·“à¶½à¶š à¶±à·à¶¸à¶º à¶‡à¶­à·”à·…à¶­à·Š à¶šà¶»à¶±à·Šà¶±.", start_button: "à¶†à¶»à¶¸à·Šà¶· à¶šà¶»à¶±à·Šà¶±", logout: "à¶‰à·€à¶­à·Š à·€à¶±à·Šà¶±", main_menu_title: "à¶´à·Šâ€à¶»à¶°à·à¶± à¶¸à·™à¶±à·”à·€", manage_workers_btn: "à·ƒà·šà·€à¶š à¶šà·…à¶¸à¶±à·à¶šà¶»à¶«à¶º", nav_work_order: "à·€à·à¶© à¶‡à¶«à·€à·”à¶¸", menu_work_order_desc: "à¶šà·…à¶¸à¶±à·à¶šà¶»à·” à·€à·’à·ƒà·’à¶±à·Š à·€à·à¶© à¶‹à¶´à¶¯à·™à·ƒà·Š à¶½à¶¶à· à¶¯à·š.", nav_production_input: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶´à·Šâ€à¶»à¶¸à·à¶«à¶º à¶‡à¶­à·”à·…à¶­à·Š à¶šà·’à¶»à·“à¶¸", menu_production_input_desc: "à·ƒà·šà·€à¶šà¶ºà· à·€à·’à·ƒà·’à¶±à·Š à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶šà·à¶»à·Šà¶º à·ƒà·à¶°à¶±à¶º à¶‡à¶­à·”à·…à¶­à·Š à¶šà¶»à¶ºà·’.", nav_inventory: "à¶­à·œà¶œ à¶‡à¶­à·”à¶½à·Šà·€à·“à¶¸/à¶´à·’à¶§à·€à·“à¶¸", menu_inventory_desc: "à¶…à¶¸à·”à¶¯à·Šâ€à¶»à·€à·Šâ€à¶º à·ƒà·„ à¶±à·’à¶¸à·’ à¶·à·à¶«à·Šà¶© à¶­à·œà¶œ à¶šà·…à¶¸à¶±à·à¶šà¶»à¶«à¶º à¶šà¶»à¶±à·Šà¶±.", nav_list: "à¶½à·à¶ºà·’à·ƒà·Šà¶­à·”à·€", menu_list_desc: "à·ƒà¶¸à·Šà¶´à·–à¶»à·Šà¶« à¶­à·œà¶œ à¶­à¶­à·Šà¶­à·Šà·€à¶º à·ƒà·„ à·€à·à¶»à·Šà¶­à· à¶¶à¶½à¶±à·Šà¶±.", attendance_header: "à¶´à·à¶¸à·’à¶«à·“à¶¸", day_workers: "à¶¯à·€à¶½à·Š à¶¸à·”à¶» à·ƒà·šà·€à¶šà¶ºà·’à¶±à·Š", night_workers: "à¶»à·à¶­à·Šâ€à¶»à·“ à¶¸à·”à¶» à·ƒà·šà·€à¶šà¶ºà·’à¶±à·Š", work_hours: "à·ƒà·šà·€à· à¶šà·à¶½à¶º", date: "à¶¯à·’à¶±à¶º", handover_notes: "à¶·à·à¶»à¶¯à·“à¶¸à·š à·ƒà¶§à·„à¶±à·Š", day_shift: "â˜€ï¸ à¶¯à·€à¶½à·Š à¶¸à·”à¶»à¶º", night_shift: "ğŸŒ™ à¶»à·à¶­à·Šâ€à¶»à·“ à¶¸à·”à¶»à¶º", machine_1: "à¶ºà¶±à·Šà¶­à·Šâ€à¶»à¶º 1", machine_2: "à¶ºà¶±à·Šà¶­à·Šâ€à¶»à¶º 2", machine_3: "à¶ºà¶±à·Šà¶­à·Šâ€à¶»à¶º 3", add_machine_entry: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶‘à¶šà¶­à·” à¶šà¶»à¶±à·Šà¶±", save_work_order: "à·€à·à¶© à¶‡à¶«à·€à·”à¶¸ à·ƒà·”à¶»à¶šà·’à¶±à·Šà¶±", manage_workers: "à·ƒà·šà·€à¶š à¶šà·…à¶¸à¶±à·à¶šà¶»à¶«à¶º", add_button: "à¶‘à¶šà¶­à·” à¶šà¶»à¶±à·Šà¶±", delete_button: "à¶¸à¶šà¶±à·Šà¶±", confirm_delete: "à¶”à¶¶à¶§ à¶¸à·™à¶º à¶¸à·à¶šà·“à¶¸à¶§ à¶…à·€à·à·Šâ€à¶º à¶¶à·€ à·€à·’à·à·Šà·€à·à·ƒà¶¯?", manage_products: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶­à·œà¶»à¶­à·”à¶»à·” à¶šà·…à¶¸à¶±à·à¶šà¶»à¶«à¶º", product_info: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶­à·œà¶»à¶­à·”à¶»à·”", save_product_spec: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶´à·’à¶»à·’à·€à·’à¶­à¶» à·ƒà·”à¶»à¶šà·’à¶±à·Šà¶±", load_product_spec: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶´à·’à¶»à·’à·€à·’à¶­à¶» à¶´à·–à¶»à¶«à¶º à¶šà¶»à¶±à·Šà¶±", client_name: "à·ƒà·šà·€à·à¶¯à·à¶ºà¶šà¶ºà·à¶œà·š à¶±à¶¸", item_name: "à¶…à¶ºà·’à¶­à¶¸à¶º", grade: "à·à·Šâ€à¶»à·šà¶«à·’à¶º", mesh: "à¶¯à·à¶½ (Mesh)", temp_condition: "à¶‹à·‚à·Šà¶«à¶­à·Šà·€ à¶­à¶­à·Šà¶­à·Šà·€à¶º", pack_weight: "à¶‡à·ƒà·”à¶»à·”à¶¸à·Š à¶¶à¶» (kg)", pack_spec: "à¶‡à·ƒà·”à¶»à·”à¶¸à·Š à¶´à·’à¶»à·’à·€à·’à¶­à¶»", mix_lot: "à¶¸à·’à·à·Šâ€à¶» à¶šà·’à¶»à·“à¶¸à·š LOT", label_lot: "à¶½à·šà¶¶à¶½à·Š LOT", bag_no: "BAG NO", prod_amount: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶´à·Šâ€à¶»à¶¸à·à¶«à¶º (kg)", test_sample: "TEST/SAMPLE", loss_rate: "à¶…à¶½à·à¶· à¶…à¶±à·”à¶´à·à¶­à¶º", remarks: "à·ƒà¶§à·„à¶±à·Š", load_work_order: "à·€à·à¶© à¶‡à¶«à·€à·”à¶¸ à¶´à·–à¶»à¶«à¶º à¶šà¶»à¶±à·Šà¶±", no_work_order: "à¶¸à·™à¶¸ à¶¯à·’à¶±à¶ºà·š à·€à·à¶© à¶‡à¶«à·€à·”à¶¸à¶šà·Š à¶±à·œà¶¸à·à¶­.", save_production_input: "à¶±à·’à·‚à·Šà¶´à·à¶¯à¶± à¶´à·Šâ€à¶»à¶¸à·à¶«à¶º à·ƒà·”à¶»à¶šà·’à¶±à·Šà¶±", copy_to_night: "à¶»à·à¶­à·Šâ€à¶»à·“à¶ºà¶§ à¶´à·’à¶§à¶´à¶­à·Š à¶šà¶»à¶±à·Šà¶±", select_workers: "à·ƒà·šà·€à¶šà¶ºà· à¶­à·à¶»à¶±à·Šà¶±" }
        };
        
        let currentLanguage = 'ko';
        let currentShiftForWorkerSelection = null;

        function updateLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('language-select').value = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        if (el.classList.contains('main-menu-btn')) {
                            const titleEl = el.querySelector('h2');
                            const descEl = el.querySelector('p');
                            if(titleEl) titleEl.textContent = translations[lang][titleEl.dataset.langKey];
                            if(descEl) descEl.textContent = translations[lang][descEl.dataset.langKey];
                        } else if (el.classList.contains('add-entry-btn')) {
                            const machine = el.dataset.machine;
                            el.textContent = `+ ${machine}í˜¸ê¸° ${translations[lang][key]}`;
                        } else {
                            el.textContent = translations[lang][key];
                        }
                    }
                }
            });
            document.documentElement.lang = lang;
        }

        const screens = ['user-selection-screen', 'main-menu-screen', 'page-wrapper'];
        const mainSections = ['work-order-section', 'production-input-section', 'inventory-section', 'list-section'];
        const appHeader = document.getElementById('app-header');
        const backBtn = document.getElementById('back-to-menu-btn');

        function showScreen(screenId) {
            screens.forEach(id => {
                document.getElementById(id).classList.toggle('section-hidden', id !== screenId);
            });
            
            if (screenId === 'user-selection-screen') {
                appHeader.classList.add('section-hidden');
            } else {
                appHeader.classList.remove('section-hidden');
                appHeader.classList.add('flex');
            }

            if (screenId === 'page-wrapper') {
                backBtn.classList.remove('section-hidden');
            } else {
                backBtn.classList.add('section-hidden');
                document.getElementById('page-header-title').textContent = translations[currentLanguage].main_menu_title;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            showScreen('user-selection-screen');
        });

        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Firebase Auth Error:", error); }
            onAuthStateChanged(auth, (user) => { if (user) { userId = user.uid; setupEventListeners(); loadInitialData(); } else { userId = null; } });
        }

        function setupEventListeners() {
            document.getElementById('start-app-btn').addEventListener('click', () => {
                const usernameInput = document.getElementById('username-input');
                if (usernameInput.value.trim() === '') { alert('ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                userName = usernameInput.value.trim();
                const userDisplayText = `ì‚¬ìš©ì: ${userName}`;
                document.getElementById('header-user-display').textContent = userDisplayText;
                showScreen('main-menu-screen');
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                userName = '';
                document.getElementById('username-input').value = '';
                showScreen('user-selection-screen');
            });

            document.getElementById('language-select').addEventListener('change', (e) => {
                updateLanguage(e.target.value);
            });

            document.querySelectorAll('.main-menu-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    showScreen('page-wrapper');
                    mainSections.forEach(id => {
                        document.getElementById(id).classList.toggle('section-hidden', id !== targetId);
                    });
                    const titleKey = e.currentTarget.querySelector('h2').dataset.langKey;
                    document.getElementById('page-header-title').textContent = translations[currentLanguage][titleKey];

                    if (targetId === 'work-order-section') {
                        loadLatestWorkOrder();
                    }
                });
            });

            document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                showScreen('main-menu-screen');
            });

            document.getElementById('wo-date').valueAsDate = new Date();
            document.getElementById('pi-date').valueAsDate = new Date();

            document.querySelectorAll('#work-order-section .add-entry-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    addWorkOrderEntry(e.currentTarget.dataset.shift, e.currentTarget.dataset.machine);
                });
            });
            document.getElementById('save-work-order-btn').addEventListener('click', saveWorkOrder);
            document.getElementById('manage-worker-btn').addEventListener('click', () => {
                document.getElementById('worker-modal').classList.remove('section-hidden');
                document.getElementById('worker-modal').classList.add('flex');
            });

            document.getElementById('load-work-order-btn').addEventListener('click', loadWorkOrderForInput);
            document.getElementById('save-production-input-btn').addEventListener('click', saveProductionInput);

            document.getElementById('close-worker-modal-btn').addEventListener('click', () => {
                document.getElementById('worker-modal').classList.add('section-hidden');
                document.getElementById('worker-modal').classList.remove('flex');
            });
            document.getElementById('add-worker-btn').addEventListener('click', addWorker);
            
            document.getElementById('close-product-modal-btn').addEventListener('click', () => {
                document.getElementById('product-modal').classList.add('section-hidden');
                document.getElementById('product-modal').classList.remove('flex');
            });
            document.getElementById('product-filter-input').addEventListener('input', (e) => {
                renderProductList(allProducts, e.target.value.toLowerCase());
            });

            document.querySelectorAll('.add-attendance-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    openWorkerSelectionModal(e.currentTarget.dataset.shift);
                });
            });
            document.getElementById('cancel-worker-selection-btn').addEventListener('click', () => {
                document.getElementById('worker-selection-modal').classList.add('section-hidden');
                document.getElementById('worker-selection-modal').classList.remove('flex');
            });
            document.getElementById('confirm-worker-selection-btn').addEventListener('click', confirmWorkerSelection);
        }

        function renderWorkerListForSelection(workers) {
            const listEl = document.getElementById('worker-selection-list');
            listEl.innerHTML = '';
            workers.forEach(worker => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="worker-select-${worker.id}" type="checkbox" value="${worker.data.name}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="worker-select-${worker.id}" class="ml-3 block text-sm font-medium text-gray-700">${worker.data.name}</label>
                `;
                listEl.appendChild(div);
            });
        }

        function openWorkerSelectionModal(shift) {
            currentShiftForWorkerSelection = shift;
            renderWorkerListForSelection(allWorkers);
            document.getElementById('worker-selection-modal').classList.remove('section-hidden');
            document.getElementById('worker-selection-modal').classList.add('flex');
        }

        function confirmWorkerSelection() {
            const selectedWorkers = [];
            document.querySelectorAll('#worker-selection-list input[type="checkbox"]:checked').forEach(checkbox => {
                selectedWorkers.push(checkbox.value);
            });
            
            const listContainerId = `${currentShiftForWorkerSelection}-worker-attendance-list`;
            const listContainer = document.getElementById(listContainerId);

            selectedWorkers.forEach(name => {
                if (listContainer.querySelector(`[data-name="${name}"]`)) return;

                const div = document.createElement('div');
                div.className = 'worker-attendance-entry space-y-1';
                div.dataset.name = name;
                const defaultStartTime = currentShiftForWorkerSelection === 'day' ? '08:00' : '19:00';
                const defaultEndTime = currentShiftForWorkerSelection === 'day' ? '19:00' : '08:00';

                div.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 items-center">
                        <p class="font-semibold col-span-3">${name}</p>
                        <div class="col-span-8 flex items-center">
                            <input type="time" class="worker-time-start w-full p-1 border rounded text-sm" value="${defaultStartTime}">
                            <span class="mx-1">~</span>
                            <input type="time" class="worker-time-end w-full p-1 border rounded text-sm" value="${defaultEndTime}">
                        </div>
                        <button class="remove-worker-btn col-span-1 text-red-500 hover:text-red-700 justify-self-end">X</button>
                    </div>
                    <div class="pl-4">
                        <input type="text" class="worker-remarks-input w-full p-1 border rounded text-sm" placeholder="íŠ¹ì´ì‚¬í•­">
                    </div>
                `;
                div.querySelector('.remove-worker-btn').onclick = () => div.remove();
                listContainer.appendChild(div);
            });

            document.getElementById('worker-selection-modal').classList.add('section-hidden');
            document.getElementById('worker-selection-modal').classList.remove('flex');
        }

        function renderProductList(products, filterText = '') {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            const filteredProducts = products.filter(p => p.data.client_name.toLowerCase().includes(filterText));
            if (filteredProducts.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center">ì¼ì¹˜í•˜ëŠ” ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }
            filteredProducts.forEach(product => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-12 gap-2 items-center p-2 rounded-lg hover:bg-gray-100';
                const infoDiv = document.createElement('div');
                infoDiv.className = 'col-span-10 cursor-pointer';
                infoDiv.innerHTML = `<span class="font-semibold">${product.data.client_name}</span><span class="text-gray-600 ml-2">${product.data.item_name}</span><span class="text-gray-500 ml-2 text-sm">(${product.data.grade})</span>`;
                infoDiv.onclick = () => loadSelectedProduct(product.id);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'col-span-2 bg-red-100 text-red-700 text-xs rounded-md py-1 hover:bg-red-200';
                deleteBtn.textContent = 'ì‚­ì œ';
                deleteBtn.onclick = () => deleteProductSpec(product.id);
                div.appendChild(infoDiv); div.appendChild(deleteBtn);
                container.appendChild(div);
            });
        }

        function loadInitialData() {
            if (!userId) return;
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/workers`), (snapshot) => { 
                allWorkers = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                const modalWorkerList = document.getElementById('worker-list-modal');
                modalWorkerList.innerHTML = '';
                allWorkers.forEach(worker => {
                    const modalDiv = document.createElement('div');
                    modalDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                    modalDiv.textContent = worker.data.name;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'ì‚­ì œ';
                    deleteBtn.className = 'text-red-500 text-xs hover:text-red-700';
                    deleteBtn.onclick = () => deleteWorker(worker.id);
                    modalDiv.appendChild(deleteBtn);
                    modalWorkerList.appendChild(modalDiv);
                });
            });
            onSnapshot(collection(db, `artifacts/${appId}/public/data/products`), (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderProductList(allProducts);
            });
        }
        
        async function addWorker() {
            if (!userId) { alert('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const input = document.getElementById('new-worker-input');
            const workerName = input.value.trim();
            if (workerName) {
                try { await addDoc(collection(db, `artifacts/${appId}/users/${userId}/workers`), { name: workerName }); input.value = ''; }
                catch (error) { console.error("Error adding worker: ", error); alert('ê·¼ë¬´ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
            }
        }

        async function deleteWorker(docId) {
            if (!userId) { alert('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            if (confirm(translations[currentLanguage].confirm_delete)) {
                try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/workers`, docId)); }
                catch (error) { console.error("Error deleting worker: ", error); alert('ê·¼ë¬´ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
            }
        }
        
        function addWorkOrderEntry(shift, machine) {
            const container = document.getElementById(`wo-${shift}-m${machine}-entries`);
            const lastEntry = container.querySelector('.production-entry:last-child');
            const dataToCopy = lastEntry ? getEntryData(lastEntry) : {};

            const template = document.getElementById('wo-entry-template');
            const clone = template.content.cloneNode(true);
            const entryDiv = clone.querySelector('.production-entry');
            
            if (shift === 'night') {
                entryDiv.classList.replace('bg-white', 'bg-gray-700');
                entryDiv.classList.replace('text-gray-800', 'text-white');
                const productInfoPanel = entryDiv.querySelector('.product-info-panel');
                productInfoPanel.classList.replace('bg-gray-50', 'bg-gray-600');
                entryDiv.querySelectorAll('.product-info-label').forEach(el => el.classList.add('text-gray-300'));
                entryDiv.querySelector('.product-info-title').classList.add('text-white');
                entryDiv.querySelectorAll('.prod-input').forEach(input => {
                    if (input.classList.contains('border-b')) {
                        input.classList.add('bg-transparent', 'text-white', 'border-gray-500');
                    } else {
                        input.classList.add('bg-gray-600', 'text-white', 'border-gray-500');
                    }
                });
            }

            for (const key in dataToCopy) {
                const input = entryDiv.querySelector(`.${key}`);
                if (input) { input.value = dataToCopy[key]; }
            }

            entryDiv.querySelector('.delete-entry-btn').addEventListener('click', (e) => { e.currentTarget.closest('.production-entry').remove(); });
            entryDiv.querySelector('.save-product-btn').addEventListener('click', (e) => saveProductSpec(e.currentTarget.closest('.production-entry')));
            entryDiv.querySelector('.load-product-modal-btn').addEventListener('click', (e) => {
                currentEditingProductEntry = e.currentTarget.closest('.production-entry');
                document.getElementById('product-modal').classList.remove('section-hidden');
                document.getElementById('product-modal').classList.add('flex');
            });
            
            const copyBtn = entryDiv.querySelector('.copy-entry-to-night-btn');
            if(shift === 'day' && copyBtn){
                copyBtn.onclick = () => {
                    const dayEntries = Array.from(container.children);
                    const entryIndex = dayEntries.indexOf(entryDiv);
                    const nightContainer = document.getElementById(`wo-night-m${machine}-entries`);
                    const targetNightEntry = nightContainer.children[entryIndex];
                    if (targetNightEntry) {
                        const currentData = getEntryData(entryDiv);
                        for (const key in currentData) {
                             const targetInput = targetNightEntry.querySelector(`.${key}`);
                             if(targetInput) targetInput.value = currentData[key];
                        }
                        alert(`${machine}í˜¸ê¸° ì •ë³´ê°€ ì•¼ê°„ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    } else {
                        alert(`ë³µì‚¬í•  ì•¼ê°„ ${machine}í˜¸ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì•¼ê°„ í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
                    }
                };
            } else if (copyBtn) {
                copyBtn.remove();
            }

            container.appendChild(clone);
        }
        
        function getEntryData(entryElement) {
            const data = {};
            entryElement.querySelectorAll('.prod-input').forEach(input => {
                const key = Array.from(input.classList).find(c => c !== 'prod-input' && !c.startsWith('w-') && !c.startsWith('p-') && !c.startsWith('border'));
                if (key) { data[key] = input.value; }
            });
            return data;
        }

        async function saveProductSpec(entryElement) {
            const productData = { client_name: entryElement.querySelector('.client_name').value, item_name: entryElement.querySelector('.item_name').value, grade: entryElement.querySelector('.grade').value, mesh: entryElement.querySelector('.mesh').value, temp_min: entryElement.querySelector('.temp_min').value, temp_max: entryElement.querySelector('.temp_max').value, pack_weight: entryElement.querySelector('.pack_weight').value, pack_spec: entryElement.querySelector('.pack_spec').value, };
            if (!productData.client_name || !productData.item_name) { alert('ì—…ì²´ëª…ê³¼ í’ˆëª©ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.'); return; }
            try { await addDoc(collection(db, `artifacts/${appId}/public/data/products`), productData); alert('ì œí’ˆ ì‚¬ì–‘ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
            catch (error) { console.error("Error saving product spec: ", error); alert('ì œí’ˆ ì‚¬ì–‘ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }

        async function deleteProductSpec(productId) {
            if (confirm(translations[currentLanguage].confirm_delete)) {
                try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, productId)); alert('ì œí’ˆ ì‚¬ì–‘ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
                catch (error) { console.error("Error deleting product spec: ", error); alert('ì œí’ˆ ì‚¬ì–‘ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
            }
        }
        
        async function loadSelectedProduct(productId) {
            if (!productId || !currentEditingProductEntry) return;
            try {
                const docSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/products`, productId));
                if (docSnap.exists()) {
                    const productData = docSnap.data();
                    for (const key in productData) {
                        const input = currentEditingProductEntry.querySelector(`.${key}`);
                        if (input) { input.value = productData[key]; }
                    }
                    document.getElementById('product-modal').classList.add('section-hidden');
                    document.getElementById('product-modal').classList.remove('flex');
                    currentEditingProductEntry = null;
                }
            } catch (error) { console.error("Error loading product: ", error); alert('ì œí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }
        
        async function saveWorkOrder() {
            if (!userId || !userName) { alert('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const date = document.getElementById('wo-date').value;
            if (!date) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!confirm(`${date} ë‚ ì§œì˜ ì‘ì—…ì§€ì‹œì„œë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const getAttendanceData = (listId) => {
                const workers = [];
                document.querySelectorAll(`#${listId} .worker-attendance-entry`).forEach(entry => {
                    workers.push({
                        name: entry.dataset.name,
                        time: `${entry.querySelector('.worker-time-start').value} ~ ${entry.querySelector('.worker-time-end').value}`,
                        remarks: entry.querySelector('.worker-remarks-input').value.trim()
                    });
                });
                return workers;
            };

            const workOrderData = { date: date, author: userName, userId: userId, createdAt: new Date().toISOString(), handover_notes: document.getElementById('wo-handover-notes').value, day_shift_workers: getAttendanceData('day-worker-attendance-list'), night_shift_workers: getAttendanceData('night-worker-attendance-list'), day_shift_entries: {}, night_shift_entries: {} };
            
            for (let i = 1; i <= 3; i++) {
                workOrderData.day_shift_entries[`machine_${i}`] = [];
                document.querySelectorAll(`#wo-day-m${i}-entries .production-entry`).forEach(entry => {
                    workOrderData.day_shift_entries[`machine_${i}`].push(getEntryData(entry));
                });
                workOrderData.night_shift_entries[`machine_${i}`] = [];
                document.querySelectorAll(`#wo-night-m${i}-entries .production-entry`).forEach(entry => {
                    workOrderData.night_shift_entries[`machine_${i}`].push(getEntryData(entry));
                });
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/work_orders`, date), workOrderData);
                alert('ì‘ì—…ì§€ì‹œì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) { console.error("Error saving work order: ", error); alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        }

        async function loadWorkOrderForInput() {
            const date = document.getElementById('pi-date').value;
            if (!date) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            const displayContainer = document.getElementById('production-input-display');
            const saveBtnContainer = document.getElementById('save-production-input-container');
            displayContainer.innerHTML = '';

            const docRef = doc(db, `artifacts/${appId}/public/data/work_orders`, date);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                renderWorkOrderForInput(docSnap.data());
                saveBtnContainer.classList.remove('section-hidden');
            } else {
                displayContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].no_work_order}</p>`;
                saveBtnContainer.classList.add('section-hidden');
            }
        }

        function renderWorkOrderForInput(data) {
            const container = document.getElementById('production-input-display');
            container.innerHTML = ''; // Clear previous content

            const createEntryHTML = (entry, shift, machine, entryIndex) => {
                return `
                    <div class="production-input-entry border rounded-lg p-4 bg-white" data-shift="${shift}" data-machine="machine_${machine}" data-index="${entryIndex}">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="col-span-full font-bold text-lg">${entry.client_name} - ${entry.item_name} (${entry.grade})</div>
                            <div><label class="text-sm text-gray-500">ë°°í•©LOT</label><p>${entry.mix_lot || ''}</p></div>
                            <div><label class="text-sm text-gray-500">ë¼ë²¨LOT</label><p>${entry.label_lot || ''}</p></div>
                            <div><label class="text-sm font-medium" data-lang-key="bag_no">BAG NO</label><input type="text" class="pi-input bag_no w-full p-1 border rounded" value="${entry.bag_no || ''}"></div>
                            <div><label class="text-sm font-medium text-blue-600" data-lang-key="prod_amount">ìƒì‚°ëŸ‰(kg)</label><input type="number" class="pi-input prod_amount w-full p-1 border rounded" value="${entry.prod_amount || ''}"></div>
                            <div><label class="text-sm font-medium" data-lang-key="loss_rate">Lossìœ¨/ë–¡</label><input type="text" class="pi-input loss_rate w-full p-1 border rounded" value="${entry.loss_rate || ''}"></div>
                        </div>
                    </div>
                `;
            };

            ['day', 'night'].forEach(shift => {
                const shiftData = data[`${shift}_shift_entries`];
                if (Object.keys(shiftData).length > 0) {
                    const shiftContainer = document.createElement('div');
                    const bgColor = shift === 'day' ? 'bg-white' : 'bg-gray-800 text-white';
                    const titleColor = shift === 'day' ? 'text-green-600' : 'text-yellow-400';
                    const titleText = shift === 'day' ? 'â˜€ï¸ ì£¼ê°„' : 'ğŸŒ™ ì•¼ê°„';
                    
                    shiftContainer.className = `${bgColor} p-6 rounded-xl shadow-md space-y-4`;
                    shiftContainer.innerHTML = `<h3 class="text-lg font-bold ${titleColor}">${titleText}</h3>`;

                    for (let i = 1; i <= 3; i++) {
                        const machineKey = `machine_${i}`;
                        if (shiftData[machineKey] && shiftData[machineKey].length > 0) {
                            const machineContainer = document.createElement('div');
                            const borderColor = shift === 'day' ? 'border-green-200' : 'border-gray-600';
                            const machineTitleColor = shift === 'day' ? 'text-green-800' : 'text-yellow-300';
                            
                            machineContainer.className = `border ${borderColor} p-4 rounded-lg space-y-4`;
                            machineContainer.innerHTML = `<h4 class="font-semibold ${machineTitleColor}">${i}í˜¸ê¸°</h4>`;
                            
                            shiftData[machineKey].forEach((entry, index) => {
                                machineContainer.innerHTML += createEntryHTML(entry, shift, i, index);
                            });
                            shiftContainer.appendChild(machineContainer);
                        }
                    }
                    container.appendChild(shiftContainer);
                }
            });
        }

        async function saveProductionInput() {
            const date = document.getElementById('pi-date').value;
            if (!date) return;
            if (!confirm(`${date} ë‚ ì§œì˜ ìƒì‚°ëŸ‰ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/work_orders`, date);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                alert('ì›ë³¸ ì‘ì—…ì§€ì‹œì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const workOrderData = docSnap.data();

            document.querySelectorAll('#production-input-display .production-input-entry').forEach(entryEl => {
                const shift = entryEl.dataset.shift;
                const machine = entryEl.dataset.machine;
                const index = parseInt(entryEl.dataset.index, 10);

                const targetEntry = workOrderData[`${shift}_shift_entries`][machine][index];
                if (targetEntry) {
                    targetEntry.bag_no = entryEl.querySelector('.bag_no').value;
                    targetEntry.prod_amount = entryEl.querySelector('.prod_amount').value;
                    targetEntry.loss_rate = entryEl.querySelector('.loss_rate').value;
                }
            });

            try {
                await updateDoc(docRef, {
                    day_shift_entries: workOrderData.day_shift_entries,
                    night_shift_entries: workOrderData.night_shift_entries
                });
                alert('ìƒì‚°ëŸ‰ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch(e) {
                console.error("Error updating production input: ", e);
                alert('ìƒì‚°ëŸ‰ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadLatestWorkOrder() {
            const workOrderRef = collection(db, `artifacts/${appId}/public/data/work_orders`);
            const q = query(workOrderRef, orderBy("createdAt", "desc"), limit(1));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                const latestData = querySnapshot.docs[0].data();
                populateWorkOrderForm(latestData);
            }
        }

        function populateWorkOrderForm(data) {
            // Clear existing form
            document.getElementById('wo-handover-notes').value = '';
            ['day', 'night'].forEach(shift => {
                 document.getElementById(`${shift}-worker-attendance-list`).innerHTML = '';
                 for (let i = 1; i <= 3; i++) {
                     document.getElementById(`wo-${shift}-m${i}-entries`).innerHTML = '';
                 }
            });

            // Populate new data
            document.getElementById('wo-handover-notes').value = data.handover_notes;

            ['day', 'night'].forEach(shift => {
                const listContainer = document.getElementById(`${shift}-worker-attendance-list`);
                data[`${shift}_shift_workers`].forEach(worker => {
                     const div = document.createElement('div');
                    div.className = 'worker-attendance-entry space-y-1';
                    div.dataset.name = worker.name;
                    const [startTime, endTime] = worker.time ? worker.time.split('~').map(t => t.trim()) : ['', ''];

                    div.innerHTML = `
                        <div class="grid grid-cols-12 gap-2 items-center">
                            <p class="font-semibold col-span-3">${worker.name}</p>
                            <div class="col-span-8 flex items-center">
                                <input type="time" class="worker-time-start w-full p-1 border rounded text-sm" value="${startTime}">
                                <span class="mx-1">~</span>
                                <input type="time" class="worker-time-end w-full p-1 border rounded text-sm" value="${endTime}">
                            </div>
                            <button class="remove-worker-btn col-span-1 text-red-500 hover:text-red-700 justify-self-end">X</button>
                        </div>
                        <div class="pl-4">
                            <input type="text" class="worker-remarks-input w-full p-1 border rounded text-sm" placeholder="íŠ¹ì´ì‚¬í•­" value="${worker.remarks || ''}">
                        </div>
                    `;
                    div.querySelector('.remove-worker-btn').onclick = () => div.remove();
                    listContainer.appendChild(div);
                });
            });

            ['day', 'night'].forEach(shift => {
                for (let i = 1; i <= 3; i++) {
                    const machineKey = `machine_${i}`;
                    if (data[`${shift}_shift_entries`][machineKey]) {
                        data[`${shift}_shift_entries`][machineKey].forEach(entryData => {
                            addWorkOrderEntry(shift, i, entryData);
                        });
                    }
                }
            });
        }

    </script>
</body>
</html>
